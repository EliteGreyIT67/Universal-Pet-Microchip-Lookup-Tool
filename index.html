<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Pet Microchip Lookup</title>
    <meta name="description" content="Identify potential manufacturers or issuing companies of a pet's microchip based on its number format.">
    <link rel="icon" href="favicon.ico">
    <!-- Tailwind CSS via CDN (defer for perf) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px);}
            to   { opacity: 1; transform: translateY(0);}
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <main class="min-h-screen flex flex-col items-center justify-center px-2 py-8">
        <!-- Logo/branding -->
        <div class="flex flex-col items-center mb-8">
            <img src="logo.svg" alt="Universal Pet Microchip Lookup Logo" class="w-16 h-16 mb-2" onerror="this.style.display='none';">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 text-center">Universal Pet Microchip Lookup</h1>
            <p class="text-gray-600 text-center mt-2 max-w-xl">Quickly identify potential manufacturers or registries for pet microchips using number prefixes. Designed for veterinary staff, shelters, and concerned pet finders.</p>
        </div>

        <!-- Main container -->
        <section class="bg-white rounded-xl shadow-xl max-w-xl w-full p-6 md:p-10 fade-in">
            <!-- Loading/Error states -->
            <div id="dataLoadingMessage" class="flex items-center gap-2 text-blue-700 bg-blue-100 border border-blue-300 rounded px-4 py-3 mb-4 text-base" style="display: none;">
                <i class="fas fa-spinner spin" aria-hidden="true"></i>
                <span>Loading microchip data...</span>
            </div>
            <div id="dataErrorMessage" class="flex items-center gap-2 text-red-700 bg-red-100 border border-red-300 rounded px-4 py-3 mb-4 text-base" style="display: none;">
                <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                <span>Error loading microchip data. Please try refreshing the page.</span>
            </div>
            <!-- Input Area -->
            <form id="lookupForm" autocomplete="off" class="flex flex-col gap-4" style="display:none;">
                <label for="microchipNumber" class="font-semibold text-gray-700">
                    Enter Microchip Number <span class="text-gray-400">(9-15 chars)</span>
                </label>
                <div class="relative flex items-center">
                    <input
                        type="text"
                        id="microchipNumber"
                        class="peer w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition font-mono"
                        placeholder="e.g., 985123456789012 or AVID123456789"
                        aria-describedby="inputError"
                        inputmode="text"
                        maxlength="20"
                        required
                    >
                    <button
                        id="clearInputButton"
                        type="button"
                        title="Clear input"
                        aria-label="Clear input"
                        class="absolute right-3 text-gray-400 hover:text-gray-700 bg-transparent border-0 p-1 outline-none"
                        style="display:none;"
                        tabindex="0"
                    >
                        <i class="fas fa-times-circle fa-lg" aria-hidden="true"></i>
                    </button>
                </div>
                <div id="inputError" class="text-sm text-red-600 mt-1" style="display:none;" aria-live="polite"></div>
                <button
                    id="lookupButton"
                    type="submit"
                    class="w-full py-3 font-semibold text-lg rounded-md bg-blue-700 text-white hover:bg-blue-800 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                    <i class="fas fa-search" aria-hidden="true"></i>
                    Lookup Manufacturer
                </button>
            </form>
            <!-- Loader spinner -->
            <div id="loader" class="flex items-center justify-center my-4" style="display:none;">
                <span class="inline-block w-8 h-8 border-4 border-blue-100 border-t-blue-700 rounded-full spin"></span>
            </div>
            <!-- Results -->
            <section id="resultsArea" class="fade-in mt-8" style="display:none;" aria-live="polite">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 border-b pb-4 mb-4">
                    <div>
                        <span class="text-gray-500">Potential Info for</span>
                        <span id="searchedChipDisplay" class="font-mono text-blue-900 font-semibold bg-blue-50 px-2 py-0.5 rounded"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="copyChipButton" class="hidden px-3 py-2 bg-blue-100 text-blue-900 font-semibold rounded hover:bg-blue-200 transition" title="Copy searched chip number">
                            <i class="fas fa-copy" aria-hidden="true"></i> Copy Chip #
                        </button>
                        <span id="copyFeedback" class="text-green-700 text-sm"></span>
                    </div>
                </div>
                <div id="testChipWarning" class="flex items-center gap-2 text-yellow-700 bg-yellow-100 border border-yellow-300 rounded px-4 py-2 mb-4 text-base" style="display:none;">
                    <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                    <span></span>
                </div>
                <!-- Direct Lookup Links -->
                <section id="directLookupLinksArea" class="mb-4" style="display:none;">
                    <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2 mb-2">
                        <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                        Direct Registry Lookups
                    </h2>
                    <p class="text-sm text-gray-600 mb-2">Try these services to find owner registration. This tool does not check live databases.</p>
                    <ul id="directLookupList" class="flex flex-col gap-2"></ul>
                </section>
                <!-- Manufacturer Info -->
                <div id="chipInfoOutput"></div>
                <!-- Not Found -->
                <div id="notFoundMessage" class="bg-blue-50 border border-blue-100 p-4 rounded mt-6 text-blue-900" style="display:none;">
                    <p class="font-bold mb-1">No specific manufacturer prefix matched in our database.</p>
                    <p class="mb-2">This tool identifies potential manufacturers based on known prefixes. It <strong>does not</strong> check live registration databases.</p>
                    <div id="countryCodeSuggestion" class="bg-amber-50 border border-amber-200 text-amber-800 px-3 py-2 rounded mb-2" style="display:none;">
                        <i class="fas fa-globe-americas mr-1" aria-hidden="true"></i>
                        <span>The entered number doesn't start with '9' or a common US/North American prefix. It may be an international chip.</span>
                    </div>
                    <strong>Next Steps:</strong>
                    <ul class="list-disc pl-6 mt-1">
                        <li>Use <strong>Direct Registry Lookups</strong> above to search various databases.</li>
                        <li>Try <a href="https://www.petmicrochiplookup.org" target="_blank" rel="noopener noreferrer" class="underline text-blue-700">AAHA Universal Pet Microchip Lookup</a>.</li>
                        <li>Also check <a href="http://www.petchip.info" target="_blank" rel="noopener noreferrer" class="underline text-blue-700">PetChip.info</a>; some registries do not participate in AAHA.</li>
                    </ul>
                </div>
            </section>
            <!-- Info box -->
            <aside class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mt-8 text-indigo-900 text-sm">
                <strong>Important:</strong> This tool provides potential manufacturer information based on prefixes only. For actual pet registration details and to find an owner, you <b>must</b> check official registries.
                <div class="mt-1">
                    Data based on "MICROCHIP FORMAT GUIDE" by <a href="http://www.microchiphelp.com" target="_blank" rel="noopener noreferrer" class="underline text-indigo-700">MicrochipHelp.com</a> / Lost Dogs of America.
                </div>
            </aside>
        </section>
        <!-- Footer -->
        <footer class="mt-8 text-gray-400 text-xs text-center">
            &copy; 2025 Universal Pet Microchip Lookup Tool. Not affiliated with any registry or manufacturer.
        </footer>
    </main>
    <!-- Script -->
    <script>
    // --- Data and DOM references ---
    let manufacturersData = [];
    let aliasMap = new Map();
    let resolvedManufacturersData = [];

    const dataLoadingMessage = document.getElementById('dataLoadingMessage');
    const dataErrorMessage = document.getElementById('dataErrorMessage');
    const lookupForm = document.getElementById('lookupForm');
    const lookupButton = document.getElementById('lookupButton');
    const microchipInput = document.getElementById('microchipNumber');
    const clearInputButton = document.getElementById('clearInputButton');
    const copyChipButton = document.getElementById('copyChipButton');
    const copyFeedbackSpan = document.getElementById('copyFeedback');
    const resultsArea = document.getElementById('resultsArea');
    const chipInfoOutputDiv = document.getElementById('chipInfoOutput');
    const notFoundMessageDiv = document.getElementById('notFoundMessage');
    const countryCodeSuggestionDiv = document.getElementById('countryCodeSuggestion');
    const inputErrorDiv = document.getElementById('inputError');
    const loader = document.getElementById('loader');
    const searchedChipDisplay = document.getElementById('searchedChipDisplay');
    const testChipWarningDiv = document.getElementById('testChipWarning');
    const directLookupLinksArea = document.getElementById('directLookupLinksArea');
    const directLookupListUl = document.getElementById('directLookupList');

    // Direct Lookup Services (shortened for brevity)
    const directLookupServices = [
        { name: "AAHA Universal Lookup (Professionals)", urlTemplate: "https://www.aaha.org/for-veterinary-professionals/microchip-search/?microchip_id={chip_id}", icon: "fas fa-hospital-user" },
        { name: "AAHA Universal Lookup (Pet Owners)", urlTemplate: "https://www.aaha.org/petmicrochiplookup?microchip_id={chip_id}", icon: "fas fa-paw" },
        { name: "PetLink", urlTemplate: "https://www.petlink.net/microchip-search/?microchip-number={chip_id}", icon: "fas fa-link" },
        { name: "HomeAgain", urlTemplate: "https://www.homeagain.com/chip-lookup/{chip_id}", icon: "fas fa-home" },
        { name: "Petkey", urlTemplate: "http://petkey.org//microchip/lookup/{chip_id}", icon: "fas fa-key" },
        { name: "BuddyID", urlTemplate: "https://my.buddyid.com/results.php?key={chip_id}", icon: "fas fa-user-friends" },
        { name: "IDTag Lookup", urlTemplate: "https://idtag.com/pet/{chip_id}", icon: "fas fa-id-badge" },
        { name: "NanoChipID", urlTemplate: "https://www.nanochipid.com/lookup/{chip_id}", icon: "fas fa-microchip" },
        { name: "Petstablished", urlTemplate: "https://petstablished.com/microchip_lookup/{chip_id}", icon: "fas fa-shield-alt" },
        { name: "FreePetChipRegistry", urlTemplate: "https://www.freepetchipregistry.com/found-pet?chip={chip_id}", icon: "fas fa-database" }
    ];

    // --- Data load (embedded) ---
    function loadMicrochipData() {
        dataLoadingMessage.style.display = 'flex';
        lookupForm.style.display = 'none';
        lookupButton.disabled = true;
        // [TRUNCATED: For brevity, insert your embeddedMicrochipData here as in the original file]
        // Example:
        const embeddedMicrochipData = [
            { "prefix": "985", "entries": [ { "brand": "HOME AGAIN", "manufacturerWebsite": "https://www.homeagain.com/", "contacts": [ { "type": "phone", "value": "888-466-3242" } ], "notes": [] } ] },
            // ... rest of data from original code ...
        ];
        try {
            manufacturersData = embeddedMicrochipData;
            manufacturersData.forEach(item => {
                if (item._aliasFor) {
                    const target = manufacturersData.find(targetItem => targetItem.prefix === item._aliasFor);
                    if (target) aliasMap.set(item.prefix, target);
                }
            });
            resolvedManufacturersData = [...manufacturersData].sort((a, b) => {
                const lenA = a.prefix === "AVID9DIGIT" ? 9.5 : a.prefix.length; 
                const lenB = b.prefix === "AVID9DIGIT" ? 9.5 : b.prefix.length;
                if (lenB !== lenA) return lenB - lenA;
                if (typeof a.prefix === 'string' && typeof b.prefix === 'string') {
                    if (a.prefix.match(/^[A-Z]+$/) && b.prefix.match(/^\d+$/)) return -1;
                    if (a.prefix.match(/^\d+$/) && b.prefix.match(/^[A-Z]+$/)) return 1;
                }
                return 0;
            });
            dataLoadingMessage.style.display = 'none';
            lookupForm.style.display = 'flex';
            lookupButton.disabled = false;
        } catch (error) {
            console.error("Failed to process microchip data:", error);
            dataLoadingMessage.style.display = 'none';
            dataErrorMessage.style.display = 'flex';
            dataErrorMessage.querySelector("span").textContent = `Error processing embedded microchip data: ${error.message}.`;
        }
    }

    // --- Input UI/UX ---
    microchipInput.addEventListener('input', () => {
        clearInputButton.style.display = microchipInput.value ? 'block' : 'none';
        microchipInput.classList.remove('border-red-500', 'focus:ring-red-400');
        inputErrorDiv.style.display = 'none';
    });
    clearInputButton.addEventListener('click', () => {
        microchipInput.value = '';
        clearInputButton.style.display = 'none';
        inputErrorDiv.style.display = 'none';
        resultsArea.style.display = 'none';
        directLookupLinksArea.style.display = 'none';
        microchipInput.focus();
    });

    // --- Copy Chip Number ---
    copyChipButton.addEventListener('click', () => {
        const chipNumberToCopy = searchedChipDisplay.textContent;
        if (chipNumberToCopy) {
            navigator.clipboard.writeText(chipNumberToCopy)
                .then(() => { copyFeedbackSpan.textContent = "Copied!"; })
                .catch(() => { copyFeedbackSpan.textContent = "Copy failed."; });
            setTimeout(() => { copyFeedbackSpan.textContent = ""; }, 2000);
        }
    });

    // --- Populate Direct Lookup Links ---
    function populateDirectLookupLinks(chipId) {
        directLookupListUl.innerHTML = '';
        directLookupServices.forEach(service => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-3 bg-blue-50 hover:bg-blue-100 border border-blue-100 rounded px-3 py-2 transition';
            const url = service.urlTemplate.replace('{chip_id}', encodeURIComponent(chipId));
            li.innerHTML = `<i class="${service.icon || 'fas fa-search'} text-blue-700" aria-hidden="true"></i> <a href="${url}" target="_blank" rel="noopener noreferrer" class="underline text-blue-900">${service.name}</a>`;
            directLookupListUl.appendChild(li);
        });
        directLookupLinksArea.style.display = 'block';
    }

    // --- Form Submission/Lookup Logic ---
    lookupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (resolvedManufacturersData.length === 0) {
            inputErrorDiv.textContent = 'Microchip data is not loaded. Please wait or refresh.';
            inputErrorDiv.style.display = 'block';
            return;
        }
        const rawChipNumber = microchipInput.value.trim();
        // Reset UI states
        inputErrorDiv.style.display = 'none';
        resultsArea.style.display = 'none';
        chipInfoOutputDiv.innerHTML = '';
        notFoundMessageDiv.style.display = 'none';
        countryCodeSuggestionDiv.style.display = 'none';
        testChipWarningDiv.style.display = 'none';
        copyChipButton.classList.add('hidden');
        copyFeedbackSpan.textContent = '';
        directLookupLinksArea.style.display = 'none';
        directLookupListUl.innerHTML = '';
        loader.style.display = 'flex';

        // Validate input
        const chipNumber = rawChipNumber.replace(/[\s-*]+/g, '').toUpperCase();
        if (!/^[A-Z0-9]{9,15}$/.test(chipNumber)) {
            microchipInput.classList.add('border-red-500', 'focus:ring-red-400');
            if (chipNumber.length < 9 || chipNumber.length > 15) {
                inputErrorDiv.textContent = 'Microchip number must be 9 to 15 characters long (after removing spaces/hyphens/asterisks).';
            } else {
                inputErrorDiv.textContent = 'Invalid characters. Only numbers (0-9) and letters (A-Z) are allowed.';
            }
            inputErrorDiv.style.display = 'block';
            loader.style.display = 'none';
            return;
        }

        // Show direct lookup links
        populateDirectLookupLinks(chipNumber);

        setTimeout(() => { // simulate processing
            let matches = [];
            let isTestChip = false;
            let testChipNote = "";

            // Test chip warning
            if (chipNumber === "933007125056789") {
                isTestChip = true;
                testChipNote = "This is a known test chip (Buddy ID).";
            } else if (chipNumber.startsWith("985170") || chipNumber.startsWith("985191")) {
                isTestChip = true;
                testChipNote = `Chips starting with ${chipNumber.substring(0,6)} may be Home Again test chips.`;
            }

            // AVID 9-digit, AVID literal, or prefix match
            if (chipNumber.length === 9 && /^\d+$/.test(chipNumber)) {
                const avid9DigitEntry = resolvedManufacturersData.find(m => m.prefix === "AVID9DIGIT");
                if (avid9DigitEntry) matches.push(avid9DigitEntry);
            } else if (chipNumber.startsWith("AVID")) {
                const avidLiteralEntry = resolvedManufacturersData.find(m => m.prefix === "AVID");
                if (avidLiteralEntry) matches.push(avidLiteralEntry);
            }
            if(matches.length === 0) {
                for (const mfrData of resolvedManufacturersData) {
                    if (mfrData.prefix === "AVID9DIGIT" || mfrData.prefix === "AVID" || mfrData._aliasFor) continue; 
                    if (chipNumber.startsWith(mfrData.prefix)) {
                        if ((mfrData.prefix === "1" || mfrData.prefix === "4") && chipNumber.length !== 10) continue;
                        matches.push(mfrData);
                        break; 
                    }
                }
            }

            loader.style.display = 'none';
            resultsArea.style.display = 'block';
            searchedChipDisplay.textContent = rawChipNumber;
            copyChipButton.classList.remove('hidden');

            // Test chip warning
            if (isTestChip) {
                testChipWarningDiv.style.display = 'flex';
                testChipWarningDiv.querySelector('span').textContent = testChipNote;
            }

            // Manufacturer info or not found
            if (matches.length > 0) {
                chipInfoOutputDiv.style.display = 'block';
                matches.forEach(match => {
                    const currentMatchData = aliasMap.get(match.prefix) || match;
                    if (!currentMatchData.entries) return;
                    currentMatchData.entries.forEach(entry => {
                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'mb-6 bg-gray-50 border border-gray-100 rounded p-4';
                        let content = `<h3 class="text-xl font-bold text-blue-900 mb-2">${entry.brand}</h3>`;
                        // Details
                        if (entry.manufacturer && entry.manufacturer !== entry.brand) {
                            content += `<p class="mb-1"><strong>Manufacturer:</strong> <span>${entry.manufacturer}</span></p>`;
                        }
                        if (entry.manufacturerWebsite) {
                            const webLink = entry.manufacturerWebsite.startsWith('http') ? entry.manufacturerWebsite : `http://${entry.manufacturerWebsite}`;
                            content += `<p class="mb-1"><strong>Website:</strong> <a href="${webLink}" target="_blank" class="underline text-blue-700">${entry.manufacturerWebsite}</a></p>`;
                        }
                        if (entry.chipTechnology) {
                            const tech = Array.isArray(entry.chipTechnology) ? entry.chipTechnology.join(', ') : entry.chipTechnology;
                            content += `<p class="mb-1"><strong>Technology:</strong> <span>${tech}</span></p>`;
                        }
                        // Contacts
                        if (entry.contacts && entry.contacts.length > 0) {
                            content += `<div class="mt-2 mb-2"><h4 class="font-semibold text-blue-800 mb-1">Contact</h4>`;
                            entry.contacts.forEach(contact => {
                                let icon = '', link = contact.value, displayValue = contact.text || contact.value, contactLine = '';
                                switch (contact.type) {
                                    case 'phone': icon = '<i class="fas fa-phone mr-2" aria-hidden="true"></i>'; link = `tel:${contact.value.replace(/[^0-9+]/g, '')}`; displayValue = contact.value; contactLine = `<a href="${link}" class="underline">${displayValue}</a>`; break;
                                    case 'web': icon = '<i class="fas fa-globe mr-2" aria-hidden="true"></i>'; link = contact.value.startsWith('http') ? contact.value : `http://${contact.value}`; contactLine = `<a href="${link}" target="_blank" class="underline">${displayValue}</a>`; break;
                                    case 'email': icon = '<i class="fas fa-envelope mr-2" aria-hidden="true"></i>'; link = `mailto:${contact.value}`; contactLine = `<a href="${link}" class="underline">${displayValue}</a>`; break;
                                    case 'address': icon = '<i class="fas fa-map-marker-alt mr-2" aria-hidden="true"></i>'; contactLine = `${displayValue}`; break;
                                    case 'fax': icon = '<i class="fas fa-fax mr-2" aria-hidden="true"></i>'; contactLine = `${displayValue}`; break;
                                    default: icon = '<i class="fas fa-info-circle mr-2" aria-hidden="true"></i>'; contactLine = `${displayValue}`;
                                }
                                content += `<p class="flex items-center">${icon}${contactLine}</p>`;
                            });
                            content += `</div>`;
                        }
                        // Links/registries
                        if (entry.relevantLinks && entry.relevantLinks.length > 0) {
                            content += `<div class="mt-2"><h5 class="font-semibold text-blue-800 mb-1">Relevant Links</h5><ul class="list-disc pl-5">`;
                            entry.relevantLinks.forEach(rLink => {
                                const webLink = rLink.url.startsWith('http') ? rLink.url : `http://${rLink.url}`;
                                let linkIcon = '<i class="fas fa-link mr-1" aria-hidden="true"></i>';
                                content += `<li>${linkIcon}<a href="${webLink}" target="_blank" class="underline">${rLink.text}</a> <span class="text-xs text-gray-400">(${rLink.type})</span></li>`;
                            });
                            content += '</ul></div>';
                        }
                        if (entry.primaryRegistries && entry.primaryRegistries.length > 0) {
                            content += `<div class="mt-2"><h5 class="font-semibold text-blue-800 mb-1">Primary Registries</h5><ul class="list-disc pl-5">`;
                            entry.primaryRegistries.forEach(registry => { content += `<li>${registry}</li>`; });
                            content += '</ul></div>';
                        }
                        // Notes
                        if (entry.notes && entry.notes.length > 0) {
                            content += `<div class="mt-2"><h5 class="font-semibold text-blue-800 mb-1">Notes</h5><ul class="list-disc pl-5 text-sm">`;
                            entry.notes.forEach(note => {
                                const noteWithLinks = note.replace(/(https?:\/\/[^\s!"'<>()]+)/g, '<a href="$1" target="_blank" class="underline">$1</a>');
                                content += `<li>${noteWithLinks}</li>`;
                            });
                            content += '</ul></div>';
                        }
                        entryDiv.innerHTML = content;
                        chipInfoOutputDiv.appendChild(entryDiv);
                    });
                });
            } else {
                chipInfoOutputDiv.style.display = 'none';
                notFoundMessageDiv.style.display = 'block';
                if (!chipNumber.startsWith('9') && !chipNumber.startsWith('AVID') && !['000','0A0','0A1','0D0D','1','4','7E1','9A1','TR'].some(p => chipNumber.startsWith(p))) {
                    countryCodeSuggestionDiv.style.display = 'block';
                }
            }
        }, 300); // processing delay
    });

    // Enter key triggers lookup
    microchipInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            if (!lookupButton.disabled) lookupButton.click();
        }
    });

    // --- Initial load ---
    loadMicrochipData();
    </script>
</body>
</html>
