<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Pet Microchip Lookup</title>
    <meta name="description" content="Identify potential manufacturers or issuing companies of a pet's microchip based on its number format.">
    <link rel="icon" href="https://placehold.co/32x32/3b82f6/ffffff?text=ðŸ¾">
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html, body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            scroll-behavior: smooth;
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(1rem); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the sidebar to make it sticky on larger screens */
        @media (min-width: 1024px) {
            .sidebar-sticky {
                position: sticky;
                top: 2rem; /* Adjust this value as needed */
            }
        }
    </style>
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <main class="container mx-auto px-4 py-8">
        <!-- Theme Toggle Button -->
        <div class="absolute top-4 right-4">
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>

        <!-- Header/Branding -->
        <header class="text-center mb-10">
            <div class="flex justify-center items-center gap-3 mb-2">
                 <svg class="w-12 h-12 text-blue-700 dark:text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5l.415-.207a.75.75 0 011.085.67V10.5m0 0h6m-6 0a.75.75 0 001.085.67l.415-.207M8.25 10.5V7.5m0 3H4.5m4.5-3H4.5m4.5 3l.415.207a.75.75 0 001.085-.67V7.5m-1.5 6a.75.75 0 00-1.085.67l-.415.207m1.5-6H12m6 3h-1.5m1.5-3h-1.5m-1.5 3l-.415.207a.75.75 0 01-1.085-.67V7.5m1.5 6a.75.75 0 01-1.085.67l-.415.207M12 21a8.25 8.25 0 006.208-3.327l-1.458-1.286A6.75 6.75 0 0112 19.5zM12 21a8.25 8.25 0 01-6.208-3.327l1.458-1.286A6.75 6.75 0 0012 19.5zM12 21v-2.502z" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Universal Pet Microchip Lookup</h1>
            </div>
            <p class="text-gray-600 dark:text-gray-400 mt-2 max-w-2xl mx-auto">Quickly identify potential manufacturers for a pet's microchip. Designed for vet staff, shelters, and pet finders.</p>
        </header>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8 max-w-7xl mx-auto">
            
            <!-- Left Column: Search & Results -->
            <div class="lg:col-span-2">
                <section class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full p-6 md:p-8">
                    <!-- Loading/Error states -->
                    <div id="dataLoadingMessage" class="flex items-center gap-2 text-blue-800 dark:text-blue-300 bg-blue-100 dark:bg-gray-700 border border-blue-300 dark:border-blue-500 rounded px-4 py-3 mb-4 text-base">
                        <i class="fas fa-spinner spin" aria-hidden="true"></i>
                        <span>Loading microchip data...</span>
                    </div>
                    <div id="dataErrorMessage" class="flex items-center gap-2 text-red-800 dark:text-red-300 bg-red-100 dark:bg-gray-700 border border-red-300 dark:border-red-500 rounded px-4 py-3 mb-4 text-base" style="display: none;">
                        <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                        <span>Error loading microchip data. Please try refreshing the page.</span>
                    </div>

                    <!-- Input Area -->
                    <form id="lookupForm" autocomplete="off" class="flex flex-col gap-4" style="display:none;">
                        <label for="microchipNumber" class="font-semibold text-gray-700 dark:text-gray-300">
                            Enter Microchip Number <span class="text-gray-400 dark:text-gray-500">(9-15 chars)</span>
                        </label>
                        <div class="relative flex items-center">
                            <input
                                type="text"
                                id="microchipNumber"
                                class="peer w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-500 transition font-mono"
                                placeholder="e.g., 985123456789012"
                                aria-describedby="inputError"
                                inputmode="text"
                                maxlength="20"
                                required
                            >
                            <button id="clearInputButton" type="button" title="Clear input" aria-label="Clear input" class="absolute right-3 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-transparent border-0 p-1 outline-none" style="display:none;" tabindex="0">
                                <i class="fas fa-times-circle fa-lg" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div id="inputError" class="text-sm text-red-600 dark:text-red-400 mt-1" style="display:none;" aria-live="polite"></div>
                        <button id="lookupButton" type="submit" class="w-full py-3 font-semibold text-lg rounded-md bg-blue-700 text-white hover:bg-blue-800 dark:bg-blue-600 dark:hover:bg-blue-700 transition disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            Lookup Manufacturer
                        </button>
                    </form>
                    
                    <!-- Results Area -->
                    <section id="resultsArea" class="fade-in mt-6" style="display:none;" aria-live="polite">
                        <!-- Loader spinner for search -->
                        <div id="loader" class="flex items-center justify-center my-4" style="display:none;">
                            <span class="inline-block w-8 h-8 border-4 border-blue-100 dark:border-blue-800 border-t-blue-700 dark:border-t-blue-500 rounded-full spin"></span>
                        </div>
                        
                        <!-- Header for results -->
                        <div id="resultsHeader" style="display:none;" class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Results for</span>
                                <span id="searchedChipDisplay" class="font-mono text-blue-900 dark:text-blue-300 font-semibold bg-blue-50 dark:bg-gray-700 px-2 py-0.5 rounded"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="copyChipButton" class="hidden px-3 py-2 bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-semibold rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition" title="Copy searched chip number">
                                    <i class="fas fa-copy" aria-hidden="true"></i> Copy
                                </button>
                                <span id="copyFeedback" class="text-green-700 dark:text-green-400 text-sm"></span>
                            </div>
                        </div>

                        <div id="testChipWarning" class="flex items-center gap-2 text-yellow-800 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-600 rounded-lg px-4 py-3 mb-4 text-base" style="display:none;">
                            <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                            <span></span>
                        </div>
                        
                        <!-- Manufacturer Info -->
                        <div id="chipInfoOutput"></div>
                        
                        <!-- Not Found Message -->
                        <div id="notFoundMessage" class="bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 p-4 rounded-lg mt-4" style="display:none;">
                            <p class="font-bold text-lg mb-2 text-gray-900 dark:text-gray-100">No Manufacturer Match Found</p>
                            <p class="mb-3 text-gray-700 dark:text-gray-300">Our database does not have a matching prefix for this chip. This does not mean the chip is invalid or unregistered.</p>
                            <div id="countryCodeSuggestion" class="bg-amber-100 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-300 px-3 py-2 rounded-md mb-3 text-sm" style="display:none;">
                                <i class="fas fa-globe-americas mr-1" aria-hidden="true"></i>
                                <span>This number format doesn't match a common US/North American prefix. It may be an international chip.</span>
                            </div>
                            <strong class="block mb-2 text-gray-800 dark:text-gray-200">Next Steps:</strong>
                             <ul class="list-disc pl-5 space-y-1 text-gray-700 dark:text-gray-300">
                                <li>Your next steps should be to use the <strong>Direct Registry Lookups</strong> on the right and, if needed, the resources in the <strong>Advanced Help</strong> section below.</li>
                                <li>Try the <a href="https://www.petmicrochiplookup.org" target="_blank" rel="noopener noreferrer" class="underline text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">AAHA Universal Pet Microchip Lookup</a>, a comprehensive tool.</li>
                                <li>Check <a href="http://www.petchip.info" target="_blank" rel="noopener noreferrer" class="underline text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">PetChip.info</a> for registries that do not participate in the AAHA lookup.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Advanced Help Section -->
                    <section id="advancedHelpSection" class="mt-8 fade-in" style="display: none;">
                        <div class="bg-teal-50 dark:bg-teal-900/30 border-l-4 border-teal-500 text-teal-800 dark:text-teal-200 p-4 rounded-r-lg">
                            <div class="flex">
                                <div class="py-1"><i class="fas fa-hands-helping fa-2x text-teal-500 dark:text-teal-400 mr-4"></i></div>
                                <div>
                                    <h3 class="font-bold text-gray-900 dark:text-white">Advanced Help: Dead-End or Unregistered Chips</h3>
                                    <p class="text-sm mt-1 text-gray-700 dark:text-gray-300">
                                        If you can't find the owner through lookups, the chip may be unregistered or the contact information may be outdated (a "dead-end chip"). Here are your next steps:
                                    </p>
                                    
                                    <div class="mt-4">
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">1. Get Help from Volunteer Tracers</h4>
                                        <p class="text-sm mt-1 text-gray-700 dark:text-gray-300">
                                            <a href="https://www.microchiphelp.com/" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:text-teal-600 dark:hover:text-teal-300">The Microchip Hunters</a> are volunteer experts at tracing difficult chips. Submit a request for assistance using the appropriate form below:
                                        </p>
                                        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-2 mt-3">
                                             <a href="https://form.jotform.com/90818285559976" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-700 rounded-md px-3 py-2 transition w-full text-sm">
                                                <i class="fas fa-user text-gray-500 dark:text-gray-400 w-4 text-center" aria-hidden="true"></i>
                                                <span class="flex-1 font-medium text-gray-800 dark:text-gray-200">Public Form</span>
                                            </a>
                                             <a href="https://form.jotform.com/90818736755975" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-700 rounded-md px-3 py-2 transition w-full text-sm">
                                                <i class="fas fa-shield-alt text-gray-500 dark:text-gray-400 w-4 text-center" aria-hidden="true"></i>
                                                <span class="flex-1 font-medium text-gray-800 dark:text-gray-200">Shelter Form</span>
                                            </a>
                                            <a href="https://form.jotform.com/90818680043963" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-700 rounded-md px-3 py-2 transition w-full text-sm">
                                                <i class="fas fa-clinic-medical text-gray-500 dark:text-gray-400 w-4 text-center" aria-hidden="true"></i>
                                                <span class="flex-1 font-medium text-gray-800 dark:text-gray-200">Vet/Police Form</span>
                                            </a>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">2. File a National Found Pet Report</h4>
                                         <p class="text-sm mt-1 text-gray-700 dark:text-gray-300">
                                            Filing a public found pet report creates a searchable record that owners can find.
                                        </p>
                                        <div class="mt-3">
                                            <a href="https://search.petfbi.org/report.html" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-700 rounded-md px-3 py-2 transition w-full text-sm max-w-xs">
                                                <i class="fas fa-bullhorn text-gray-500 dark:text-gray-400 w-4 text-center" aria-hidden="true"></i>
                                                <span class="flex-1 font-medium text-gray-800 dark:text-gray-200">Report to Pet FBI</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </section>
            </div>

            <!-- Right Column: Sidebar -->
            <aside id="sidebar" class="lg:col-span-1 mt-8 lg:mt-0 fade-in" style="display: none;">
                <div class="sidebar-sticky space-y-6">
                    <!-- Direct Lookup Links -->
                    <section id="directLookupLinksArea" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2 mb-2">
                            <i class="fas fa-external-link-alt text-gray-500 dark:text-gray-400" aria-hidden="true"></i>
                            Direct Registry Lookups
                        </h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Use these services to search for owner registration. This tool only identifies the possible manufacturer.</p>
                        <ul id="directLookupList" class="flex flex-col gap-2"></ul>
                    </section>
                    
                    <!-- Important Info Box -->
                    <section class="bg-indigo-50 dark:bg-indigo-900/40 border border-indigo-200 dark:border-indigo-800 rounded-lg p-4 text-indigo-900 dark:text-indigo-200 text-sm">
                        <strong>Important:</strong> This tool provides potential manufacturer information based on prefixes only. For actual pet registration details and to find an owner, you <b>must</b> check official registries.
                        <div class="mt-1">
                            Data based on "MICROCHIP FORMAT GUIDE" by <a href="http://www.microchiphelp.com" target="_blank" rel="noopener noreferrer" class="underline text-indigo-700 dark:text-indigo-300">MicrochipHelp.com</a> / Lost Dogs of America.
                        </div>
                    </section>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-gray-500 dark:text-gray-400 text-xs text-center">
            &copy; 2025 Universal Pet Microchip Lookup Tool. Not affiliated with any registry or manufacturer.
        </footer>
    </main>

    <!-- Script -->
    <script>
    // --- Theme Toggle ---
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
    const themeToggleButton = document.getElementById('theme-toggle');

    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        themeToggleLightIcon.classList.remove('hidden');
    } else {
        document.documentElement.classList.remove('dark');
        themeToggleDarkIcon.classList.remove('hidden');
    }

    themeToggleButton.addEventListener('click', function() {
        themeToggleDarkIcon.classList.toggle('hidden');
        themeToggleLightIcon.classList.toggle('hidden');
        if (localStorage.getItem('color-theme')) {
            if (localStorage.getItem('color-theme') === 'light') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            }
        } else {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
        }
    });

    // --- Data and DOM references ---
    let manufacturersData = [];
    let aliasMap = new Map();
    let resolvedManufacturersData = [];

    const dataLoadingMessage = document.getElementById('dataLoadingMessage');
    const dataErrorMessage = document.getElementById('dataErrorMessage');
    const lookupForm = document.getElementById('lookupForm');
    const lookupButton = document.getElementById('lookupButton');
    const microchipInput = document.getElementById('microchipNumber');
    const clearInputButton = document.getElementById('clearInputButton');
    const copyChipButton = document.getElementById('copyChipButton');
    const copyFeedbackSpan = document.getElementById('copyFeedback');
    const resultsArea = document.getElementById('resultsArea');
    const resultsHeader = document.getElementById('resultsHeader');
    const chipInfoOutputDiv = document.getElementById('chipInfoOutput');
    const notFoundMessageDiv = document.getElementById('notFoundMessage');
    const countryCodeSuggestionDiv = document.getElementById('countryCodeSuggestion');
    const inputErrorDiv = document.getElementById('inputError');
    const loader = document.getElementById('loader');
    const searchedChipDisplay = document.getElementById('searchedChipDisplay');
    const testChipWarningDiv = document.getElementById('testChipWarning');
    const sidebar = document.getElementById('sidebar');
    const directLookupListUl = document.getElementById('directLookupList');
    const advancedHelpSection = document.getElementById('advancedHelpSection');

    // Direct Lookup Services
    const directLookupServices = [
        { name: "AAHA Universal Lookup (Pro)", urlTemplate: "https://www.aaha.org/for-veterinary-professionals/microchip-search/?microchip_id={chip_id}", icon: "fas fa-hospital-user" },
        { name: "AAHA Universal Lookup (Owner)", urlTemplate: "https://www.aaha.org/petmicrochiplookup?microchip_id={chip_id}", icon: "fas fa-paw" },
        { name: "PetLink", urlTemplate: "https://www.petlink.net/microchip-search/?microchip-number={chip_id}", icon: "fas fa-link" },
        { name: "HomeAgain", urlTemplate: "https://www.homeagain.com/chip-lookup/{chip_id}", icon: "fas fa-home" },
        { name: "Fi Nano Lookup", urlTemplate: "https://nano.tryfi.com/?s={chip_id}", icon: "fas fa-dog" },
        { name: "MyPetHealth", urlTemplate: "https://www.mypethealth.com/auth/report/pet?query={chip_id}", icon: "fas fa-file-medical" },
        { name: "Peeva Lookup", urlTemplate: "https://peeva.co/microchip-lookup/?chipNumber={chip_id}", icon: "fas fa-search-location" },
        { name: "Petkey", urlTemplate: "http://petkey.org//microchip/lookup/{chip_id}", icon: "fas fa-key" },
        { name: "BuddyID", urlTemplate: "https://my.buddyid.com/results.php?key={chip_id}", icon: "fas fa-user-friends" },
        { name: "IDTag Pet Search", urlTemplate: "https://idtag.com/pet-search/?chip={chip_id}", icon: "fas fa-id-badge" },
        { name: "NanoChipID", urlTemplate: "https://www.nanochipid.com/lookup/{chip_id}", icon: "fas fa-microchip" },
        { name: "Petstablished", urlTemplate: "https://petstablished.com/microchip_lookup/{chip_id}", icon: "fas fa-shield-alt" },
        { name: "FreePetChipRegistry", urlTemplate: "https://www.freepetchipregistry.com/found-pet?chip={chip_id}", icon: "fas fa-database" }
    ];

    // --- Data load (embedded) ---
    function loadMicrochipData() {
        // UPDATED: Added new prefixes and aliases
        const embeddedMicrochipData = [
            {"prefix":"840","entries":[{"brand":"USDA Animal Tracking","notes":["Prefix reserved for US official animal tracking. May not be a pet chip."]}]},
            {"prefix":"900","entries":[{"brand":"ACA MARRS","manufacturerWebsite":"https://www.marrsmicrochip.com","contacts":[{"type":"phone","value":"800-992-0571"},{"type":"web","value":"https://www.marrsmicrochip.com"}],"notes":["Prefix for chips not otherwise listed. No info if unenrolled.","The 900 prefix is a shared code used by hundreds of smaller or international manufacturers, making them very difficult to trace if unregistered."]}]},
            {"prefix":"900032","entries":[{"brand":"UNKNOWN","notes":["Mystery chip. Can try Get Me Known (getmeknown.co.za)."]}]},
            {"prefix":"900074","entries":[{"brand":"SMART TAG (ID Tag)","manufacturerWebsite":"https://idtag.com","contacts":[{"type":"phone","value":"201-537-5644"},{"type":"phone","text":"24/7 Hotline","value":"888-521-0808"},{"type":"phone","text":"Support","value":"866-603-6863"},{"type":"email","value":"support@idtag.com"},{"type":"web","value":"https://idtag.com"}],"notes":["Info if unenrolled."]}]},
            {"prefix":"900085","entries":[{"brand":"PETSTABLISHED","manufacturerWebsite":"https://petstablished.com","contacts":[{"type":"phone","value":"855-684-3184 ext 3"},{"type":"email","value":"support@petstablished.com"},{"type":"web","value":"https://petstablished.com"}]},{"brand":"HOMEWARDBOUND","contacts":[{"type":"phone","value":"844-643-4663"}]},{"brand":"ONLINE AMAZON","manufacturerWebsite":"REXID-PET.COM"}]},
            {"prefix":"900101","entries":[{"brand":"ARDES","manufacturerWebsite":"https://www.ardes-sa.com/en/","notes":["INTERNATIONAL (France). Primarily for livestock identification."]}]},
            {"prefix":"900108","entries":[{"brand":"ViaGuard","contacts":[{"type":"phone","value":"877-842-4827"}],"notes":["No info if unenrolled."]}]},
            {"prefix":"900111","entries":[{"brand":"INTERNATIONAL PET REGISTRY (IPR)","contacts":[{"type":"phone","value":"844-477-7387"}],"notes":["Info if unenrolled, but manufacturer may sell direct to consumer."]}]},
            {"prefix":"900113","_aliasFor":"900111"},
            {"prefix":"900115","_aliasFor":"900111"},
            {"prefix":"900116","_aliasFor":"900111"},
            {"prefix":"900118","_aliasFor":"900111"},
            {"prefix":"900139","_aliasFor":"900074"},
            {"prefix":"900164","entries":[{"brand":"SAVE THIS LIFE / Multiple Vendors","contacts":[{"type":"phone","value":"855-777-2447"}]}]},
            {"prefix":"900182","entries":[{"brand":"Plastifran BV","manufacturerWebsite":"https://www.plastifran.nl/","notes":["This is a shared 900-series code used by Plastifran BV. See also prefix 993."]}]},
            {"prefix":"900200","entries":[{"brand":"K9 Microchips / Pet Chip LLC","notes":["Company has stated they do not maintain a traditional recovery database. Owner registration is critical."]}]},
            {"prefix":"900215","entries":[{"brand":"isenvo.com","manufacturerWebsite":"https://isenvo.com","notes":["Sold direct to consumer from Amazon."]}]},
            {"prefix":"900223","entries":[{"brand":"Get Me Known","manufacturerWebsite":"https://www.getmeknown.co.za/"},{"brand":"Five Star ID","manufacturerWebsite":"https://www.fivestarid.co.za/"}]},
            {"prefix":"900235","entries":[{"brand":"Fi Nano","manufacturerWebsite":"https://nano.tryfi.com/","contacts":[{"type":"phone","value":"1-888-434-3647","text":"Fi Nano Support"},{"type":"phone","value":"855-626-6817","text":"Fi Collar Support"},{"type":"web","value":"https://nano.tryfi.com/"}]}]},
            {"prefix":"900250","entries":[{"brand":"FURREKA","manufacturerWebsite":"https://furreka.com","contacts":[{"type":"phone","value":"844-387-7352"},{"type":"web","value":"https://furreka.com"}]}]},
            {"prefix":"900258","entries":[{"brand":"Vethub","manufacturerWebsite":"https://vethub.com.au","contacts":[{"type":"web","value":"https://vethub.com.au"}],"notes":["AUSTRALIA"]}]},
            {"prefix":"900262","entries":[{"brand":"Homeward Bound","manufacturerWebsite":"https://www.homewardbound.com/","contacts":[{"type":"phone","value":"800-434-2843"}],"notes":["Linked to Buddy ID."]}]},
            {"prefix":"900263","entries":[{"brand":"Leader Products","manufacturerWebsite":"https://www.leaderproducts.com/","notes":["INTERNATIONAL (Australia). Primarily for livestock identification."]}]},
            {"prefix":"901017","entries":[{"brand":"UI Devices","contacts":[{"type":"phone","value":"224-444-8484"}]}]},
            {"prefix":"911","entries":[{"brand":"911PETCHIP / FREE PET CHIP REGISTRY","manufacturerWebsite":"https://www.freepetchipregistry.com","contacts":[{"type":"phone","text":"Lost Pet Recovery","value":"888-546-7615"},{"type":"web","value":"https://www.freepetchipregistry.com"},{"type":"web","value":"https://911petchip.com"},{"type":"email","value":"admin@911petchip.com"}],"notes":["Info if unenrolled."]}]},
            {"prefix":"927","entries":[{"brand":"Flucky (Humanada S.A. de C.V.)","contacts":[{"type":"phone","value":"+52 614 142 6826"},{"type":"email","value":"info@flucky.com.mx"}],"notes":["MEXICO"]}]},
            {"prefix":"932","entries":[{"brand":"LAMBERT VET SUPPLY (ADEQID)","notes":["No registry kept."]}]},
            {"prefix":"933","entries":[{"brand":"BUDDY ID (Microchip ID Systems)","manufacturerWebsite":"https://buddyid.com","contacts":[{"type":"phone","value":"800-434-2843"},{"type":"web","value":"https://buddyid.com"}],"notes":["Info if unenrolled. 933007125056789 is a test chip."]},{"brand":"Get Me Known","manufacturerWebsite":"https://www.getmeknown.co.za/"}]},
            {"prefix":"939","entries":[{"brand":"RealTrace","manufacturerWebsite":"https://www.realtrace.com/en/","notes":["INTERNATIONAL (Europe). May not have a North American recovery database."]}]},
            {"prefix":"941","entries":[{"brand":"Felixcan","manufacturerWebsite":"https://www.felixcan.com/eng/Id_Elec.html","contacts":[{"type":"phone","value":"+34 967 52 01 87"}],"notes":["INTERNATIONAL (Spain). Unlikely to be registered in US databases."]}]},
            {"prefix":"941","entries":[{"brand":"PETKEY","manufacturerWebsite":"https://www.petkey.org","contacts":[{"type":"phone","value":"866-699-3463"},{"type":"web","value":"https://www.petkey.org"},{"type":"phone","text":"Lost Pet Support","value":"734-600-3463"}]},{"brand":"24PETWATCH","manufacturerWebsite":"https://www.24petwatch.com","contacts":[{"type":"phone","text":"General Inquiries / Lost Pet","value":"866-597-2424"},{"type":"web","value":"https://www.24petwatch.com"},{"type":"email","text":"Media Inquiry","value":"marketing@pethealthinc.com"}]}]},
            {"prefix":"944","entries":[{"brand":"Micro-ID (UK)","manufacturerWebsite":"http://www.iso-944.com/","notes":["INTERNATIONAL (UK). Unlikely to be registered in US databases."]}]},
            {"prefix":"945","entries":[{"brand":"Pet-ID (UK)","manufacturerWebsite":"https://www.pet-id.net/","contacts":[{"type":"phone","value":"+44 1243 825438"}],"notes":["INTERNATIONAL (UK). Unlikely to be registered in US databases."]}]},
            {"prefix":"952","entries":[{"brand":"MICROCHIP 4 SOLUTIONS","contacts":[{"type":"phone","value":"877-738-4384"}]}]},
            {"prefix":"953","entries":[{"brand":"Virbac BackHome","manufacturerWebsite":"https://www.backhome.co.za/","contacts":[{"type":"phone","value":"+27 11 027 8837"},{"type":"email","value":"backhome@virbac.co.za"}],"notes":["INTERNATIONAL (South Africa). Unlikely to be registered in US databases."]}]},
            {"prefix":"956","entries":[{"brand":"AKC Reunite","manufacturerWebsite":"https://www.akcreunite.org","contacts":[{"type":"phone","value":"800-252-7894"},{"type":"web","value":"https://www.akcreunite.org"}]}]},
            {"prefix":"958","entries":[{"brand":"Pet Chip Registry","manufacturerWebsite":"https://www.petchipregistry.com/","contacts":[{"type":"phone","value":"866-211-9582"}]}]},
            {"prefix":"963","entries":[{"brand":"Animalltag","manufacturerWebsite":"https://animalltag.com.br/en/","contacts":[{"type":"phone","value":"+55 16 3362-3362"}],"notes":["INTERNATIONAL (Brazil). Unlikely to be registered in US databases."]}]},
            {"prefix":"963084","entries":[{"brand":"Saving-Life","contacts":[{"type":"phone","value":"888-577-7938"}]}]},
            {"prefix":"965","_aliasFor":"933"},
            {"prefix":"966","entries":[{"brand":"Global Pet Security","manufacturerWebsite":"https://www.gps.pet/","notes":["No info if unenrolled."]}]},
            {"prefix":"967","entries":[{"brand":"IDENTRAC","contacts":[{"type":"email","value":"info@identrac.ca"}]},{"brand":"EasyTrac-ID","manufacturerWebsite":"https://easytrac-id.com/","notes":["INTERNATIONAL (Europe). Unlikely to be registered in US databases."]}]},
            {"prefix":"968","entries":[{"brand":"SAINT (PET PARENT)","contacts":[{"type":"email","value":"info@aapp-pets.org"}]},{"brand":"French Canadian aZoo.me","contacts":[{"type":"email","value":"info@aZoo.me"}]},{"brand":"Saving-Life","contacts":[{"type":"phone","value":"888-577-7938"}]}]},
            {"prefix":"972","entries":[{"brand":"K9 REG (Canada)","manufacturerWebsite":"https://k9reg.com/","notes":["CANADA based. Check Canadian registries."]}]},
            {"prefix":"977","entries":[{"brand":"AVID","contacts":[{"type":"phone","value":"800-336-2843"}]}]},
            {"prefix":"978","_aliasFor":"953"},
            {"prefix":"98100","entries":[{"brand":"Datamars / Temple Tag","notes":["Check europetnet.org and Petmaxx."]}]},
            {"prefix":"981001","_aliasFor":"98102"},
            {"prefix":"981010","entries":[{"brand":"Banfield","contacts":[{"type":"phone","value":"800-838-6738"}]}]},
            {"prefix":"981016","entries":[{"brand":"Be-Spotted","manufacturerWebsite":"https://be-spotted.com/","contacts":[{"type":"web","value":"https://be-spotted.com/"}]}]},
            {"prefix":"98102","entries":[{"brand":"PETLINK (Datamars)","manufacturerWebsite":"https://www.petlink.net","contacts":[{"type":"phone","value":"877-738-5465","text":"1-877-PETLINK"},{"type":"web","value":"https://www.petlink.net"}]},{"brand":"24PETWATCH","manufacturerWebsite":"https://www.24petwatch.com","contacts":[{"type":"phone","text":"General Inquiries / Lost Pet","value":"866-597-2424"},{"type":"web","value":"https://www.24petwatch.com"},{"type":"email","text":"Media Inquiry","value":"marketing@pethealthinc.com"}]}]},
            {"prefix":"981020","entries":[{"brand":"EIDAP Inc.","manufacturerWebsite":"https://www.eidap.com/","contacts":[{"type":"phone","value":"888-346-8899"}],"notes":["CANADA based."]}]},
            {"prefix":"98103","_aliasFor":"98102"},
            {"prefix":"981100","entries":[{"brand":"Datamars or 'Dog ID'","notes":["Check europetnet.org and Petmaxx."]}]},
            {"prefix":"982","entries":[{"brand":"24PETWATCH","manufacturerWebsite":"https://www.24petwatch.com","contacts":[{"type":"phone","text":"General Inquiries / Lost Pet","value":"866-597-2424"},{"type":"web","value":"https://www.24petwatch.com"},{"type":"email","text":"Media Inquiry","value":"marketing@pethealthinc.com"}]}]},
            {"prefix":"982126", "_aliasFor": "982"},
            {"prefix":"985","entries":[{"brand":"HOME AGAIN","manufacturerWebsite":"https://www.homeagain.com","contacts":[{"type":"phone","value":"888-466-3242"},{"type":"web","value":"https://www.homeagain.com"}],"notes":["985170... and 985191... are often test chips."]}]},
            {"prefix":"987","_aliasFor":"900074"},
            {"prefix":"988","entries":[{"brand":"Multiple / Unknown","notes":["This is a shared manufacturer code that may be difficult to trace. Check MyPetHQ.io for more info."]}]},
            {"prefix":"989","entries":[{"brand":"Biomark Inc.","notes":["Primarily used for wildlife and conservation research. May not be enrolled in a public pet recovery database. You can try contacting MyPetHQ.io for assistance."]}]},
            {"prefix":"990","entries":[{"brand":"NANOCHIPID.com","manufacturerWebsite":"https://www.nanochipid.com/","contacts":[{"type":"phone","value":"855-434-2447"},{"type":"web","value":"https://www.nanochipid.com"}],"notes":["Info if unenrolled."]},{"brand":"VIAGUARD","contacts":[{"type":"phone","value":"877-842-4827"}],"notes":["No info if unenrolled."]}]},
            {"prefix":"991","entries":[{"brand":"SAVE THIS LIFE","contacts":[{"type":"phone","value":"855-777-2447"}]},{"brand":"911PETCHIP / FREE PET CHIP REGISTRY","manufacturerWebsite":"https://www.freepetchipregistry.com","contacts":[{"type":"phone","text":"Lost Pet Recovery","value":"888-546-7615"},{"type":"web","value":"https://www.freepetchipregistry.com"},{"type":"web","value":"https://911petchip.com"}]},{"brand":"PEEVA","contacts":[{"type":"phone","value":"833-733-8226"}],"notes":["No info if unenrolled."]}]},
            {"prefix":"992","entries":[{"brand":"ACA MARRS","manufacturerWebsite":"https://www.marrsmicrochip.com","contacts":[{"type":"phone","value":"800-992-0571"},{"type":"web","value":"https://www.marrsmicrochip.com"}],"notes":["No info if unenrolled."]},{"brand":"INTERNATIONAL PET REGISTRY","contacts":[{"type":"phone","value":"844-477-7387"}]},{"brand":"NANOCHIPID.com","manufacturerWebsite":"https://www.nanochipid.com/","contacts":[{"type":"phone","value":"855-434-2447"},{"type":"web","value":"https://www.nanochipid.com"}]},{"brand":"PETKEY","manufacturerWebsite":"https://www.petkey.org","contacts":[{"type":"phone","value":"866-699-3463"},{"type":"web","value":"https://www.petkey.org"},{"type":"phone","text":"Lost Pet Support","value":"734-600-3463"}]},{"brand":"SMART TRAC","manufacturerWebsite":"PETMAXX.COM"},{"brand":"24 PETWATCH","manufacturerWebsite":"https://www.24petwatch.com","contacts":[{"type":"phone","text":"General Inquiries / Lost Pet","value":"866-597-2424"},{"type":"web","value":"https://www.24petwatch.com"}]}]},
            {"prefix":"993","entries":[{"brand":"Plastifran BV","manufacturerWebsite":"https://www.plastifran.nl/","notes":["INTERNATIONAL (Netherlands). Company primarily makes livestock identification and may not have a public pet recovery service."]}]},
            {"prefix":"998","_aliasFor":"900085"},
            {"prefix":"999","entries":[{"brand":"Test Chips","notes":["Should not have been released. Report to andie@icar.org."]}]},
            {"prefix":"AVID9DIGIT","_isVirtual":true,"entries":[{"brand":"AVID (9-Digit)","manufacturerWebsite":"https://www.avidid.com/","contacts":[{"type":"phone","value":"800-336-2843"},{"type":"web","value":"https://www.avidid.com/"}],"chipTechnology":["125 kHz"]}]},
            {"prefix":"000","_aliasFor":"956"},
            {"prefix":"0A0","_aliasFor":"933"},
            {"prefix":"0A1","_aliasFor":"982"},
            {"prefix":"0D0D","entries":[{"brand":"BANFIELD (HOME AGAIN)","manufacturerWebsite":"https://www.homeagain.com","contacts":[{"type":"phone","value":"877-567-8738"},{"type":"web","value":"https://www.homeagain.com"}]}]},
            {"prefix":"1","_aliasFor":"AVID9DIGIT"},
            {"prefix":"4","_aliasFor":"985"},
            {"prefix":"7E1","_aliasFor":"933"},
            {"prefix":"9A1","_aliasFor":"982"},
            {"prefix":"TR","_aliasFor":"956"}
        ];
        
        try {
            manufacturersData = embeddedMicrochipData;
            manufacturersData.forEach(item => {
                if (item._aliasFor) {
                    const target = manufacturersData.find(targetItem => targetItem.prefix === item._aliasFor);
                    if (target) aliasMap.set(item.prefix, target);
                }
            });
            resolvedManufacturersData = [...manufacturersData].sort((a, b) => {
                const lenA = a.prefix === "AVID9DIGIT" ? 9.5 : a.prefix.length; 
                const lenB = b.prefix === "AVID9DIGIT" ? 9.5 : b.prefix.length;
                if (lenB !== lenA) return lenB - lenA;
                if (typeof a.prefix === 'string' && typeof b.prefix === 'string') {
                    if (a.prefix.match(/^[A-Z]+$/) && b.prefix.match(/^\d+$/)) return -1;
                    if (a.prefix.match(/^\d+$/) && b.prefix.match(/^[A-Z]+$/)) return 1;
                }
                return 0;
            });
            dataLoadingMessage.style.display = 'none';
            lookupForm.style.display = 'flex';
        } catch (error) {
            console.error("Failed to process microchip data:", error);
            dataLoadingMessage.style.display = 'none';
            dataErrorMessage.style.display = 'flex';
            dataErrorMessage.querySelector("span").textContent = `Error processing embedded microchip data: ${error.message}.`;
        }
    }

    // --- Input UI/UX ---
    microchipInput.addEventListener('input', () => {
        clearInputButton.style.display = microchipInput.value ? 'block' : 'none';
        microchipInput.classList.remove('border-red-500', 'focus:ring-red-400');
        inputErrorDiv.style.display = 'none';
    });
    clearInputButton.addEventListener('click', () => {
        microchipInput.value = '';
        clearInputButton.style.display = 'none';
        inputErrorDiv.style.display = 'none';
        resultsArea.style.display = 'none';
        sidebar.style.display = 'none';
        advancedHelpSection.style.display = 'none';
        microchipInput.focus();
    });

    // --- Copy Chip Number ---
    copyChipButton.addEventListener('click', () => {
        const chipNumberToCopy = searchedChipDisplay.textContent;
        if (chipNumberToCopy) {
             try {
                const textArea = document.createElement("textarea");
                textArea.value = chipNumberToCopy;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyFeedbackSpan.textContent = "Copied!";
            } catch (err) {
                copyFeedbackSpan.textContent = "Copy failed.";
            }
            setTimeout(() => { copyFeedbackSpan.textContent = ""; }, 2000);
        }
    });

    // --- Populate Direct Lookup Links ---
    function populateDirectLookupLinks(chipId) {
        directLookupListUl.innerHTML = '';
        directLookupServices.forEach(service => {
            const li = document.createElement('li');
            const url = service.urlTemplate.replace(/{chip_id}/g, encodeURIComponent(chipId));
            li.innerHTML = `
                <a href="${url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-700 rounded-md px-3 py-2 transition w-full">
                    <i class="${service.icon || 'fas fa-search'} text-gray-500 dark:text-gray-400 w-5 text-center" aria-hidden="true"></i> 
                    <span class="flex-1 text-gray-800 dark:text-gray-200 font-medium text-sm">${service.name}</span>
                    <i class="fas fa-external-link-alt text-gray-400 dark:text-gray-500 fa-xs" aria-hidden="true"></i>
                </a>`;
            directLookupListUl.appendChild(li);
        });
    }
    
    // --- Card Creation Helpers ---
    const createCard = (title, icon, children) => {
        if (!children || children.trim().length === 0) return '';
        return `
            <div class="bg-white dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm mb-4">
                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 px-4 py-2 border-b border-gray-200 dark:border-gray-700 rounded-t-lg flex items-center gap-2">
                    <i class="${icon} text-gray-500 dark:text-gray-400" aria-hidden="true"></i>
                    ${title}
                </h3>
                <div class="p-4 space-y-3">${children}</div>
            </div>`;
    };

    // --- Form Submission/Lookup Logic ---
    lookupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (resolvedManufacturersData.length === 0) {
            inputErrorDiv.textContent = 'Microchip data is not loaded. Please wait or refresh.';
            inputErrorDiv.style.display = 'block';
            return;
        }
        const rawChipNumber = microchipInput.value.trim();
        // Reset UI states
        inputErrorDiv.style.display = 'none';
        chipInfoOutputDiv.innerHTML = '';
        notFoundMessageDiv.style.display = 'none';
        countryCodeSuggestionDiv.style.display = 'none';
        testChipWarningDiv.style.display = 'none';
        copyChipButton.classList.add('hidden');
        resultsHeader.style.display = 'none';
        copyFeedbackSpan.textContent = '';
        advancedHelpSection.style.display = 'none';
        
        resultsArea.style.display = 'block';
        loader.style.display = 'flex';
        sidebar.style.display = 'none'; // Hide sidebar until search completes

        const chipNumber = rawChipNumber.replace(/[\s-*]+/g, '').toUpperCase();
        if (!/^[A-Z0-9]{9,15}$/.test(chipNumber)) {
            microchipInput.classList.add('border-red-500', 'focus:ring-red-400');
            inputErrorDiv.textContent = chipNumber.length < 9 || chipNumber.length > 15 
                ? 'Microchip number must be 9 to 15 characters long.'
                : 'Invalid characters. Only numbers (0-9) and letters (A-Z) are allowed.';
            inputErrorDiv.style.display = 'block';
            loader.style.display = 'none';
            return;
        }

        setTimeout(() => { 
            populateDirectLookupLinks(chipNumber); 
            sidebar.style.display = 'block'; 
            advancedHelpSection.style.display = 'block'; 

            let matches = [];
            if (chipNumber === "933007125056789") { testChipWarningDiv.style.display = 'flex'; testChipWarningDiv.querySelector('span').textContent = "This is a known test chip (Buddy ID)."; }
            if (chipNumber.startsWith("985170") || chipNumber.startsWith("985191")) { testChipWarningDiv.style.display = 'flex'; testChipWarningDiv.querySelector('span').textContent = `Chips starting with ${chipNumber.substring(0,6)} may be Home Again test chips.`; }

            if (chipNumber.length === 9 && /^\d+$/.test(chipNumber)) {
                const avid9DigitEntry = resolvedManufacturersData.find(m => m.prefix === "AVID9DIGIT");
                if (avid9DigitEntry) matches.push(avid9DigitEntry);
            } else if (chipNumber.startsWith("AVID")) {
                const avidLiteralEntry = resolvedManufacturersData.find(m => m.prefix === "AVID");
                if (avidLiteralEntry) matches.push(avidLiteralEntry);
            }
            if(matches.length === 0) {
                for (const mfrData of resolvedManufacturersData) {
                    if (mfrData._aliasFor || mfrData._isVirtual) continue; 
                    if (chipNumber.startsWith(mfrData.prefix)) {
                        matches.push(mfrData);
                        break; 
                    }
                }
            }
            
            // Check for aliases if no primary match was found
            if(matches.length === 0) {
                for (const mfrData of resolvedManufacturersData) {
                    if (!mfrData._aliasFor) continue;
                    if (chipNumber.startsWith(mfrData.prefix)) {
                       const aliasedMatch = aliasMap.get(mfrData.prefix);
                       if(aliasedMatch) {
                           matches.push(aliasedMatch);
                           break;
                       }
                    }
                }
            }


            loader.style.display = 'none';
            resultsHeader.style.display = 'flex';
            searchedChipDisplay.textContent = rawChipNumber;
            copyChipButton.classList.remove('hidden');

            if (matches.length > 0) {
                chipInfoOutputDiv.style.display = 'block';
                notFoundMessageDiv.style.display = 'none';
                matches.forEach(match => {
                    let currentMatchData = match;
                    // Note: Aliases are already resolved before this loop in the new logic
                    
                    currentMatchData.entries.forEach(entry => {
                        let mainInfo = `<h2 class="text-2xl font-bold text-blue-800 dark:text-blue-300">${entry.brand}</h2>`;
                        if (entry.manufacturer && entry.manufacturer.toLowerCase() !== entry.brand.toLowerCase()) mainInfo += `<p class="text-gray-600 dark:text-gray-400 text-sm">by ${entry.manufacturer}</p>`;
                        if (entry.manufacturerWebsite) {
                            const webLink = entry.manufacturerWebsite.startsWith('http') ? entry.manufacturerWebsite : `https://${entry.manufacturerWebsite.replace(/^https?:\/\//, '')}`;
                            mainInfo += `<a href="${webLink}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline text-sm flex items-center gap-1 mt-1">${entry.manufacturerWebsite} <i class="fas fa-external-link-alt fa-xs"></i></a>`;
                        }
                        if (entry.chipTechnology) mainInfo += `<div class="mt-2"><span class="bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${Array.isArray(entry.chipTechnology) ? entry.chipTechnology.join(', ') : entry.chipTechnology}</span></div>`;
                        
                        let contactsContent = (entry.contacts || []).map(contact => {
                            const iconMap = { phone: 'fa-phone', web: 'fa-globe', email: 'fa-envelope' };
                            const icon = `<i class="fas ${iconMap[contact.type] || 'fa-info-circle'} fa-fw" aria-hidden="true"></i>`;
                            let link, displayValue;
                            
                            switch(contact.type) {
                                case 'phone':
                                    link = `tel:${contact.value.replace(/[^0-9+]/g, '')}`;
                                    displayValue = contact.text ? `${contact.value} (${contact.text})` : contact.value;
                                    break;
                                case 'email':
                                    link = `mailto:${contact.value}`;
                                    displayValue = contact.text || contact.value;
                                    break;
                                case 'web':
                                    link = contact.value.startsWith('http') ? contact.value : `https://www.${contact.value.replace(/^https?:\/\/(www\.)?/, '')}`;
                                    displayValue = contact.text || contact.value.replace(/^https?:\/\/(www\.)?/, '');
                                    break;
                                default:
                                    link = '#';
                                    displayValue = contact.value;
                            }
                            const line = `<a href="${link}" ${contact.type !== 'email' ? 'target="_blank" rel="noopener noreferrer"' : ''} class="underline hover:text-blue-500">${displayValue}</a>`;
                            return `<div class="flex items-center gap-3 text-sm"><span class="text-gray-500 dark:text-gray-400 w-5 text-center">${icon}</span><span class="text-gray-800 dark:text-gray-200">${line}</span></div>`;
                        }).join('');

                        let notesContent = (entry.notes || []).length > 0 ? `<ul class="list-disc pl-4 text-sm text-gray-700 dark:text-gray-300 space-y-1">${entry.notes.map(note => `<li>${note.replace(/(https?:\/\/[^\s!"'<>()]+)/g, '<a href="$1" target="_blank" class="underline">$1</a>')}</li>`).join('')}</ul>` : '';

                        const entryDiv = document.createElement('div');
                        entryDiv.innerHTML = createCard('Manufacturer Info', 'fas fa-info-circle', mainInfo) + createCard('Contact', 'fas fa-address-book', contactsContent) + createCard('Notes', 'fas fa-clipboard', notesContent);
                        chipInfoOutputDiv.appendChild(entryDiv);
                    });
                });
            } else {
                chipInfoOutputDiv.style.display = 'none';
                notFoundMessageDiv.style.display = 'block';
                if (!chipNumber.startsWith('9') && !chipNumber.startsWith('AVID')) countryCodeSuggestionDiv.style.display = 'block';
            }
        }, 300); 
    });

    // Enter key triggers lookup
    microchipInput.addEventListener('keypress', (e) => e.key === 'Enter' && (e.preventDefault(), lookupButton.click()));

    // --- Initial load ---
    window.onload = loadMicrochipData;
    </script>
</body>
</html>
