<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Microchip Lookup (JSON Data)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        .container {
            max-width: 750px; 
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .title {
            font-size: 2rem; 
            font-weight: 700;
            color: #1e40af; 
            margin-bottom: 2rem;
            text-align: center;
        }
        .input-label {
            font-weight: 600; 
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
        }
        .input-field {
            width: 100%;
            padding: 0.875rem 1.125rem; 
            padding-right: 3rem; 
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 1rem;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        .clear-button {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            display: none; 
        }
        .clear-button:hover {
            color: #1f2937;
        }
        .button {
            width: 100%;
            padding: 0.875rem 1rem;
            background-color: #1d4ed8; 
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1rem;
        }
        .button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .action-button { 
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            background-color: #e0e7ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
            margin-left: 0.5rem;
        }
        .action-button:hover {
            background-color: #c7d2fe;
        }
        .results-area {
            margin-top: 2.5rem;
        }
        .results-title {
            font-size: 1.5rem; 
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-entry {
            background-color: #f9fafb;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.25rem;
            border: 1px solid #e5e7eb;
        }
        .result-entry h3 { 
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.75rem;
        }
        .result-item {
            margin-bottom: 0.625rem;
            color: #4b5563;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .result-item strong {
            color: #1f2937;
            font-weight: 500;
        }
        .result-item i { 
            margin-right: 0.5rem;
            color: #3b82f6;
            width: 16px; 
            text-align: center;
        }
        .result-item a {
            color: #2563eb;
            text-decoration: underline;
            word-break: break-all;
        }
        .result-item a:hover {
            color: #1d4ed8;
        }
        .notes-list {
            margin-top: 0.75rem;
            padding-left: 1.25rem;
        }
        .notes-list li {
            margin-bottom: 0.375rem;
            list-style-type: disc;
        }
        .contact-section, .notes-section {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #d1d5db;
        }
        .contact-section:first-child, .notes-section:first-child {
             margin-top:0;
             padding-top:0;
             border-top: none;
        }
        .error-message, .warning-message, .loading-message {
            color: #c81e1e; 
            font-weight: 500;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 6px;
        }
        .warning-message {
            color: #a16207;
            background-color: #fef9c3;
            border: 1px solid #fde047;
        }
        .loading-message {
            color: #1e40af;
            background-color: #e0e7ff;
            border: 1px solid #c7d2fe;
            text-align: center;
        }
        .info-box {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #3730a3;
        }
        .info-box strong {
            font-weight: 600;
        }
        .info-box a {
            color: #3b82f6;
            font-weight: 500;
            text-decoration: underline;
        }
        .loader {
            border: 5px solid #e5e7eb; 
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto 0;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chip-number-display {
            font-weight: 500;
            background-color: #e0e7ff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: #3730a3;
        }
        .copy-feedback {
            font-size: 0.75rem;
            color: #16a34a; 
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Universal Pet Microchip Lookup</h1>
        
        <div id="dataLoadingMessage" class="loading-message" style="display: none;">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading microchip data...
        </div>
        <div id="dataErrorMessage" class="error-message" style="display: none;">
            Error loading microchip data. Please try refreshing the page.
        </div>

        <div id="lookupInterface" style="display:none;"> <div>
                <label for="microchipNumber" class="input-label">Enter Microchip Number (9-15 characters):</label>
                <div class="input-wrapper">
                    <input type="text" id="microchipNumber" class="input-field" placeholder="e.g., 985123456789012 or AVID123456789">
                    <button id="clearInputButton" class="clear-button" title="Clear input">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div id="inputError" class="error-message" style="display: none;" aria-live="polite"></div>
            </div>

            <button id="lookupButton" class="button">
                <i class="fas fa-search mr-2"></i>Lookup Manufacturer
            </button>
        </div>
        <div id="loader" class="loader"></div>

        <div id="resultsArea" class="results-area" style="display: none;" aria-live="polite">
            <div class="results-title">
                <span>Potential Info for <span id="searchedChipDisplay" class="chip-number-display"></span></span>
                <button id="copyChipButton" class="button action-button" title="Copy searched chip number" style="display:none;">
                    <i class="fas fa-copy"></i> Copy Chip #
                </button>
            </div>
             <span id="copyFeedback" class="copy-feedback block text-right -mt-4 mb-2"></span>
            <div id="testChipWarning" class="warning-message" style="display: none;"></div>
            <div id="chipInfoOutput">
                </div>
            <div id="notFoundMessage" class="info-box" style="display: none;">
                <p class="font-semibold text-lg mb-2">No specific manufacturer prefix matched in our database.</p>
                <p>This tool identifies potential manufacturers based on common prefixes from the "MICROCHIP FORMAT GUIDE" (MicrochipHelp.com / Lost Dogs of America, updated 02/04/2025). It <strong>does not</strong> check live registration databases.</p>
                <div id="countryCodeSuggestion" style="display:none; margin-top: 0.5rem; padding: 0.5rem; background-color: #ffedd5; border: 1px solid #fed7aa; border-radius: 4px;">
                    <p class="font-semibold text-amber-700"><i class="fas fa-globe-americas mr-1"></i>International Chip? The entered number doesn't start with '9' or a common US/North American prefix. It might use an <a href="https://en.wikipedia.org/wiki/ISO_3166-1_numeric#Current_codes" target="_blank" rel="noopener noreferrer" class="underline">ISO Country Code</a>.</p>
                </div>
                <p class="mt-2"><strong>Next Steps:</strong></p>
                <ul class="list-disc list-inside ml-4 mt-1">
                    <li><strong>ALWAYS use the <a href="https://www.petmicrochiplookup.org" target="_blank" rel="noopener noreferrer">AAHA Universal Pet Microchip Lookup</a>.</strong> This tool searches multiple actual registration databases.</li>
                    <li>Also check <a href="http://www.petchip.info" target="_blank" rel="noopener noreferrer">PetChip.info</a>, as some registries do not participate in the AAHA tool.</li>
                    <li>For chips potentially from outside the US, check international databases like <a href="http://www.europetnet.com/" target="_blank" rel="noopener noreferrer">Europetnet</a> and <a href="http://www.petmaxx.com/" target="_blank" rel="noopener noreferrer">PetMaxx</a>.</li>
                </ul>
            </div>
        </div>
        
        <div class="info-box mt-8">
            <p><strong>Important:</strong> This tool provides potential manufacturer information based on prefixes. For actual pet registration details and to find an owner, you <strong>MUST</strong> use a comprehensive lookup service like the <a href="https://www.petmicrochiplookup.org" target="_blank" rel="noopener noreferrer">AAHA Universal Pet Microchip Lookup</a>.</p>
            <p class="mt-1">Data based on "MICROCHIP FORMAT GUIDE" (MicrochipHelp.com / Lost Dogs of America, updated 02/04/2025).</p>
        </div>
    </div>

    <script>
        let manufacturersData = [];
        let aliasMap = new Map();
        let resolvedManufacturersData = [];

        const dataLoadingMessage = document.getElementById('dataLoadingMessage');
        const dataErrorMessage = document.getElementById('dataErrorMessage');
        const lookupInterface = document.getElementById('lookupInterface');
        const lookupButton = document.getElementById('lookupButton');
        const microchipInput = document.getElementById('microchipNumber');
        const clearInputButton = document.getElementById('clearInputButton');
        const copyChipButton = document.getElementById('copyChipButton');
        const copyFeedbackSpan = document.getElementById('copyFeedback');
        const resultsArea = document.getElementById('resultsArea');
        const chipInfoOutputDiv = document.getElementById('chipInfoOutput');
        const notFoundMessageDiv = document.getElementById('notFoundMessage');
        const countryCodeSuggestionDiv = document.getElementById('countryCodeSuggestion');
        const inputErrorDiv = document.getElementById('inputError');
        const loader = document.getElementById('loader');
        const searchedChipDisplay = document.getElementById('searchedChipDisplay');
        const testChipWarningDiv = document.getElementById('testChipWarning');

        async function loadMicrochipData() {
            dataLoadingMessage.style.display = 'block';
            lookupInterface.style.display = 'none';
            lookupButton.disabled = true;
            try {
                // Use './' for an explicit relative path from the current directory
                const response = await fetch('./microchip_data.json'); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                manufacturersData = await response.json();
                
                manufacturersData.forEach(item => {
                    if (item._aliasFor) {
                        const target = manufacturersData.find(targetItem => targetItem.prefix === item._aliasFor);
                        if (target) {
                            aliasMap.set(item.prefix, target);
                        }
                    }
                });

                resolvedManufacturersData = manufacturersData
                    .filter(item => !item._aliasFor) 
                    .map(item => { 
                        const originalItem = aliasMap.get(item.prefix); 
                        return originalItem ? { ...originalItem, prefix: item.prefix } : { ...item }; 
                    });

                resolvedManufacturersData.sort((a, b) => {
                    const lenA = a.prefix === "AVID9DIGIT" ? 9.5 : a.prefix.length; 
                    const lenB = b.prefix === "AVID9DIGIT" ? 9.5 : b.prefix.length;
                    if (lenB !== lenA) {
                        return lenB - lenA; 
                    }
                    if (typeof a.prefix === 'string' && typeof b.prefix === 'string') {
                        if (a.prefix.match(/^[A-Z]+$/) && b.prefix.match(/^\d+$/)) return -1; 
                        if (a.prefix.match(/^\d+$/) && b.prefix.match(/^[A-Z]+$/)) return 1;  
                    }
                    return 0;
                });

                dataLoadingMessage.style.display = 'none';
                lookupInterface.style.display = 'block';
                lookupButton.disabled = false;

            } catch (error) {
                console.error("Failed to load microchip data:", error);
                dataLoadingMessage.style.display = 'none';
                dataErrorMessage.textContent = `Error loading microchip data: ${error.message}. Please try refreshing the page. Ensure 'microchip_data.json' is in the same directory as index.html.`;
                dataErrorMessage.style.display = 'block';
            }
        }

        microchipInput.addEventListener('input', () => {
            clearInputButton.style.display = microchipInput.value ? 'block' : 'none';
        });

        clearInputButton.addEventListener('click', () => {
            microchipInput.value = '';
            clearInputButton.style.display = 'none';
            inputErrorDiv.style.display = 'none';
            resultsArea.style.display = 'none';
            microchipInput.focus();
        });
        
        copyChipButton.addEventListener('click', () => {
            const chipNumberToCopy = searchedChipDisplay.textContent;
            if (chipNumberToCopy) {
                const textarea = document.createElement('textarea');
                textarea.value = chipNumberToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyFeedbackSpan.textContent = 'Copied!';
                } catch (err) {
                    copyFeedbackSpan.textContent = 'Failed to copy.';
                }
                document.body.removeChild(textarea);
                setTimeout(() => { copyFeedbackSpan.textContent = ''; }, 2000);
            }
        });

        lookupButton.addEventListener('click', () => {
            if (resolvedManufacturersData.length === 0) {
                inputErrorDiv.textContent = 'Microchip data is not loaded. Please wait or refresh.';
                inputErrorDiv.style.display = 'block';
                return;
            }
            const rawChipNumber = microchipInput.value.trim();
            inputErrorDiv.style.display = 'none'; 
            resultsArea.style.display = 'none'; 
            chipInfoOutputDiv.innerHTML = ''; 
            notFoundMessageDiv.style.display = 'none';
            countryCodeSuggestionDiv.style.display = 'none';
            testChipWarningDiv.style.display = 'none';
            copyChipButton.style.display = 'none';
            copyFeedbackSpan.textContent = '';
            loader.style.display = 'block';

            if (!rawChipNumber) {
                inputErrorDiv.textContent = 'Please enter a microchip number.';
                inputErrorDiv.style.display = 'block';
                loader.style.display = 'none';
                return;
            }

            const chipNumber = rawChipNumber.replace(/[\s-*]+/g, '').toUpperCase(); 

            if (!/^[A-Z0-9]{9,15}$/.test(chipNumber)) {
                if (chipNumber.length < 9 || chipNumber.length > 15) {
                    inputErrorDiv.textContent = 'Microchip number should be 9 to 15 characters long (after removing spaces/hyphens/asterisks).';
                } else {
                    inputErrorDiv.textContent = 'Invalid characters. Use numbers (0-9) and letters (A-Z) only.';
                }
                inputErrorDiv.style.display = 'block';
                loader.style.display = 'none';
                return;
            }
            
            setTimeout(() => {
                let matches = [];
                let isTestChip = false;
                let testChipNote = "";

                if (chipNumber === "933007125056789") {
                    isTestChip = true;
                    testChipNote = "This specific number (933007125056789) is identified as a test chip (Buddy ID).";
                } else if (chipNumber.startsWith("985170") || chipNumber.startsWith("985191")) {
                    isTestChip = true;
                    testChipNote = `Chips starting with ${chipNumber.substring(0,6)} (like this one) can be Home Again test chips if they had no shipping info and should not be in circulation.`;
                }

                if (chipNumber.length === 9 && /^\d+$/.test(chipNumber)) {
                    const avid9DigitEntry = resolvedManufacturersData.find(m => m.prefix === "AVID9DIGIT");
                    if (avid9DigitEntry) matches.push(avid9DigitEntry);
                } else if (chipNumber.startsWith("AVID")) {
                    const avidLiteralEntry = resolvedManufacturersData.find(m => m.prefix === "AVID");
                    if (avidLiteralEntry) matches.push(avidLiteralEntry);
                }
                
                if(matches.length === 0) {
                    for (const mfrData of resolvedManufacturersData) {
                        if (mfrData.prefix === "AVID9DIGIT" || mfrData.prefix === "AVID") continue; 
                        
                        if (chipNumber.startsWith(mfrData.prefix)) {
                            if ((mfrData.prefix === "1" || mfrData.prefix === "4") && chipNumber.length !== 10) {
                                continue;
                            }
                             const aliasedItem = aliasMap.get(mfrData.prefix) || mfrData;
                             matches.push(aliasedItem);
                            break; 
                        }
                    }
                }

                resultsArea.style.display = 'block';
                loader.style.display = 'none';
                searchedChipDisplay.textContent = rawChipNumber;
                copyChipButton.style.display = 'inline-block';

                if (isTestChip) {
                    testChipWarningDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i><strong>Test Chip Warning:</strong> ${testChipNote}`;
                    testChipWarningDiv.style.display = 'block';
                }

                if (matches.length > 0) {
                    matches.forEach(match => {
                        const currentMatchData = aliasMap.get(match.prefix) || match; 

                        if (currentMatchData.generalNote) {
                            const generalNoteEl = document.createElement('p');
                            generalNoteEl.className = 'result-item italic mb-3 text-sm text-gray-600';
                            generalNoteEl.innerHTML = `<strong>Note for prefix ${currentMatchData.prefix}:</strong> ${currentMatchData.generalNote}`;
                            chipInfoOutputDiv.appendChild(generalNoteEl);
                        }
                        currentMatchData.entries.forEach(entry => {
                            const entryDiv = document.createElement('div');
                            entryDiv.className = 'result-entry';
                            
                            let content = `<h3>${entry.brand}</h3>`;
                            if (entry.manufacturer && entry.manufacturer !== entry.brand) {
                                content += `<p class="result-item"><strong>Manufacturer:</strong> ${entry.manufacturer}</p>`;
                            }
                            
                            let hasContacts = entry.contacts && entry.contacts.length > 0;
                            let hasNotes = entry.notes && entry.notes.length > 0;

                            if (hasContacts) {
                                content += '<div class="contact-section"><p class="result-item"><strong>Contacts:</strong></p>';
                                entry.contacts.forEach(contact => {
                                    let icon = '';
                                    let link = contact.value;
                                    let displayValue = contact.text || contact.value;
                                    if (contact.type === 'phone') {
                                        icon = '<i class="fas fa-phone"></i>';
                                        link = `tel:${contact.value.replace(/[^0-9+]/g, '')}`;
                                    } else if (contact.type === 'web') {
                                        icon = '<i class="fas fa-globe"></i>';
                                        link = contact.value.startsWith('http') ? contact.value : `http://${contact.value}`;
                                    } else if (contact.type === 'email') {
                                        icon = '<i class="fas fa-envelope"></i>';
                                        link = `mailto:${contact.value}`;
                                    }
                                    content += `<p class="result-item ml-4">${icon}<a href="${link}" target="_blank" rel="noopener noreferrer">${displayValue}</a></p>`;
                                });
                                content += '</div>';
                            }

                            if (hasNotes) {
                                content += `<div class="${hasContacts ? 'notes-section' : ''}"><p class="result-item"><strong>Notes:</strong></p><ul class="notes-list">`;
                                entry.notes.forEach(note => {
                                    const noteWithLinks = note.replace(/(https?:\/\/[^\s!"'<>()]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                                    content += `<li>${noteWithLinks}</li>`;
                                });
                                content += '</ul></div>';
                            }
                            entryDiv.innerHTML = content;
                            chipInfoOutputDiv.appendChild(entryDiv);
                        });
                    });
                } else {
                    notFoundMessageDiv.style.display = 'block';
                    if (!chipNumber.startsWith('9') && !chipNumber.startsWith('AVID') && 
                        !['000','0A0','0A1','0D0D','1','4','7E1','9A1','TR'].some(p => chipNumber.startsWith(p))) {
                        countryCodeSuggestionDiv.style.display = 'block';
                    }
                }
            }, 300);
        });

        microchipInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                if (!lookupButton.disabled) { 
                    lookupButton.click();
                }
            }
        });

        loadMicrochipData();
    </script>
</body>
</html>

