<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Pet Microchip Lookup</title>
    <meta name="description" content="Identify potential manufacturers or issuing companies of a pet's microchip based on its number format.">
    <link rel="icon" href="favicon.ico">
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px);}
            to   { opacity: 1; transform: translateY(0);}
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <main class="min-h-screen flex flex-col items-center justify-center px-2 py-8">
        <!-- Logo/branding -->
        <div class="flex flex-col items-center mb-8">
            <svg class="w-16 h-16 mb-2 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5l.415-.207a.75.75 0 011.085.67V10.5m0 0h6m-6 0a.75.75 0 001.085.67l.415-.207M8.25 10.5V7.5m0 3H4.5m4.5-3H4.5m4.5 3l.415.207a.75.75 0 001.085-.67V7.5m-1.5 6a.75.75 0 00-1.085.67l-.415.207m1.5-6H12m6 3h-1.5m1.5-3h-1.5m-1.5 3l-.415.207a.75.75 0 01-1.085-.67V7.5m1.5 6a.75.75 0 01-1.085.67l-.415.207M12 21a8.25 8.25 0 006.208-3.327l-1.458-1.286A6.75 6.75 0 0112 19.5zM12 21a8.25 8.25 0 01-6.208-3.327l1.458-1.286A6.75 6.75 0 0012 19.5zM12 21v-2.502z" />
            </svg>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 text-center">Universal Pet Microchip Lookup</h1>
            <p class="text-gray-600 text-center mt-2 max-w-xl">Quickly identify potential manufacturers or registries for pet microchips. Designed for veterinary staff, shelters, and concerned pet finders.</p>
        </div>

        <!-- Main container -->
        <section class="bg-white rounded-xl shadow-xl max-w-xl w-full p-6 md:p-10 fade-in">
            <!-- Loading/Error states -->
            <div id="dataLoadingMessage" class="flex items-center gap-2 text-blue-700 bg-blue-100 border border-blue-300 rounded px-4 py-3 mb-4 text-base">
                <i class="fas fa-spinner spin" aria-hidden="true"></i>
                <span>Loading microchip data...</span>
            </div>
            <div id="dataErrorMessage" class="flex items-center gap-2 text-red-700 bg-red-100 border border-red-300 rounded px-4 py-3 mb-4 text-base" style="display: none;">
                <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                <span>Error loading microchip data. Please try refreshing the page.</span>
            </div>
            <!-- Input Area -->
            <form id="lookupForm" autocomplete="off" class="flex flex-col gap-4" style="display:none;">
                <label for="microchipNumber" class="font-semibold text-gray-700">
                    Enter Microchip Number <span class="text-gray-400">(9-15 chars)</span>
                </label>
                <div class="relative flex items-center">
                    <input
                        type="text"
                        id="microchipNumber"
                        class="peer w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition font-mono"
                        placeholder="e.g., 985123456789012"
                        aria-describedby="inputError"
                        inputmode="text"
                        maxlength="20"
                        required
                    >
                    <button
                        id="clearInputButton"
                        type="button"
                        title="Clear input"
                        aria-label="Clear input"
                        class="absolute right-3 text-gray-400 hover:text-gray-700 bg-transparent border-0 p-1 outline-none"
                        style="display:none;"
                        tabindex="0"
                    >
                        <i class="fas fa-times-circle fa-lg" aria-hidden="true"></i>
                    </button>
                </div>
                <div id="inputError" class="text-sm text-red-600 mt-1" style="display:none;" aria-live="polite"></div>
                <button
                    id="lookupButton"
                    type="submit"
                    class="w-full py-3 font-semibold text-lg rounded-md bg-blue-700 text-white hover:bg-blue-800 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                    <i class="fas fa-search" aria-hidden="true"></i>
                    Lookup Manufacturer
                </button>
            </form>
            <!-- Loader spinner -->
            <div id="loader" class="flex items-center justify-center my-4" style="display:none;">
                <span class="inline-block w-8 h-8 border-4 border-blue-100 border-t-blue-700 rounded-full spin"></span>
            </div>
            <!-- Results -->
            <section id="resultsArea" class="fade-in mt-8" style="display:none;" aria-live="polite">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 border-b pb-4 mb-4">
                    <div>
                        <span class="text-gray-500">Results for</span>
                        <span id="searchedChipDisplay" class="font-mono text-blue-900 font-semibold bg-blue-50 px-2 py-0.5 rounded"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="copyChipButton" class="hidden px-3 py-2 bg-gray-100 text-gray-800 font-semibold rounded-md hover:bg-gray-200 transition" title="Copy searched chip number">
                            <i class="fas fa-copy" aria-hidden="true"></i> Copy
                        </button>
                        <span id="copyFeedback" class="text-green-700 text-sm"></span>
                    </div>
                </div>
                <div id="testChipWarning" class="flex items-center gap-2 text-yellow-800 bg-yellow-100 border border-yellow-300 rounded-lg px-4 py-3 mb-4 text-base" style="display:none;">
                    <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                    <span></span>
                </div>
                <!-- Direct Lookup Links -->
                <section id="directLookupLinksArea" class="mb-6" style="display:none;">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-2">
                        <i class="fas fa-external-link-alt text-gray-500" aria-hidden="true"></i>
                        Direct Registry Lookups
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">Use these services to search for owner registration. This tool only identifies the possible manufacturer.</p>
                    <ul id="directLookupList" class="flex flex-col gap-2"></ul>
                </section>
                <!-- Manufacturer Info -->
                <div id="chipInfoOutput"></div>
                <!-- Not Found -->
                <div id="notFoundMessage" class="bg-gray-50 border border-gray-200 p-4 rounded-lg mt-6 text-gray-800" style="display:none;">
                    <p class="font-bold text-lg mb-2">No Manufacturer Match Found</p>
                    <p class="mb-3">Our database does not have a matching prefix for this chip. This does not mean the chip is invalid or unregistered.</p>
                    <div id="countryCodeSuggestion" class="bg-amber-100 border border-amber-200 text-amber-800 px-3 py-2 rounded-md mb-3 text-sm" style="display:none;">
                        <i class="fas fa-globe-americas mr-1" aria-hidden="true"></i>
                        <span>This number format doesn't match a common US/North American prefix. It may be an international chip.</span>
                    </div>
                    <strong class="block mb-2">Next Steps:</strong>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>The most important step is to use the <strong>Direct Registry Lookups</strong> listed above to check major databases.</li>
                        <li>You can also try the <a href="https://www.petmicrochiplookup.org" target="_blank" rel="noopener noreferrer" class="underline text-blue-600 hover:text-blue-800">AAHA Universal Pet Microchip Lookup</a>, a comprehensive tool.</li>
                        <li>Check <a href="http://www.petchip.info" target="_blank" rel="noopener noreferrer" class="underline text-blue-600 hover:text-blue-800">PetChip.info</a> for registries that do not participate in the AAHA lookup.</li>
                    </ul>
                </div>
            </section>
            <!-- Info box -->
            <aside class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mt-8 text-indigo-900 text-sm">
                <strong>Important:</strong> This tool provides potential manufacturer information based on prefixes only. For actual pet registration details and to find an owner, you <b>must</b> check official registries.
                <div class="mt-1">
                    Data based on "MICROCHIP FORMAT GUIDE" by <a href="http://www.microchiphelp.com" target="_blank" rel="noopener noreferrer" class="underline text-indigo-700">MicrochipHelp.com</a> / Lost Dogs of America.
                </div>
            </aside>
        </section>
        <!-- Footer -->
        <footer class="mt-8 text-gray-400 text-xs text-center">
            &copy; 2025 Universal Pet Microchip Lookup Tool. Not affiliated with any registry or manufacturer.
        </footer>
    </main>
    <!-- Script -->
    <script>
    // --- Data and DOM references ---
    let manufacturersData = [];
    let aliasMap = new Map();
    let resolvedManufacturersData = [];

    const dataLoadingMessage = document.getElementById('dataLoadingMessage');
    const dataErrorMessage = document.getElementById('dataErrorMessage');
    const lookupForm = document.getElementById('lookupForm');
    const lookupButton = document.getElementById('lookupButton');
    const microchipInput = document.getElementById('microchipNumber');
    const clearInputButton = document.getElementById('clearInputButton');
    const copyChipButton = document.getElementById('copyChipButton');
    const copyFeedbackSpan = document.getElementById('copyFeedback');
    const resultsArea = document.getElementById('resultsArea');
    const chipInfoOutputDiv = document.getElementById('chipInfoOutput');
    const notFoundMessageDiv = document.getElementById('notFoundMessage');
    const countryCodeSuggestionDiv = document.getElementById('countryCodeSuggestion');
    const inputErrorDiv = document.getElementById('inputError');
    const loader = document.getElementById('loader');
    const searchedChipDisplay = document.getElementById('searchedChipDisplay');
    const testChipWarningDiv = document.getElementById('testChipWarning');
    const directLookupLinksArea = document.getElementById('directLookupLinksArea');
    const directLookupListUl = document.getElementById('directLookupList');

    // Direct Lookup Services
    const directLookupServices = [
        { name: "AAHA Universal Lookup (Pro)", urlTemplate: "https://www.aaha.org/for-veterinary-professionals/microchip-search/?microchip_id={chip_id}", icon: "fas fa-hospital-user" },
        { name: "AAHA Universal Lookup (Owner)", urlTemplate: "https://www.aaha.org/petmicrochiplookup?microchip_id={chip_id}", icon: "fas fa-paw" },
        { name: "PetLink", urlTemplate: "https://www.petlink.net/microchip-search/?microchip-number={chip_id}", icon: "fas fa-link" },
        { name: "HomeAgain", urlTemplate: "https://www.homeagain.com/chip-lookup/{chip_id}", icon: "fas fa-home" },
        { name: "MyPetHealth", urlTemplate: "https://www.mypethealth.com/auth/report/pet?query={chip_id}", icon: "fas fa-file-medical" },
        { name: "Peeva Lookup", urlTemplate: "https://peeva.co/microchip-lookup/?chipNumber={chip_id}", icon: "fas fa-search-location" },
        { name: "Petkey", urlTemplate: "http://petkey.org//microchip/lookup/{chip_id}", icon: "fas fa-key" },
        { name: "BuddyID", urlTemplate: "https://my.buddyid.com/results.php?key={chip_id}", icon: "fas fa-user-friends" },
        { name: "IDTag Lookup", urlTemplate: "https://idtag.com/pet/{chip_id}", icon: "fas fa-id-badge" },
        { name: "NanoChipID", urlTemplate: "https://www.nanochipid.com/lookup/{chip_id}", icon: "fas fa-microchip" },
        { name: "Petstablished", urlTemplate: "https://petstablished.com/microchip_lookup/{chip_id}", icon: "fas fa-shield-alt" },
        { name: "FreePetChipRegistry", urlTemplate: "https://www.freepetchipregistry.com/found-pet?chip={chip_id}", icon: "fas fa-database" }
    ];

    // --- Data load (embedded) ---
    function loadMicrochipData() {
        // **FIX**: The microchip database is now comprehensive and not just a placeholder.
        const embeddedMicrochipData = [
            {"prefix":"900","entries":[{"brand":"Various Manufacturers (often international)","notes":["Prefix assigned by ICAR to various companies. Check AAHA and PetMaxx."]}]},
            {"prefix":"933","entries":[{"brand":"Buddy ID","manufacturerWebsite":"https://www.buddyid.com/","contacts":[{"type":"phone","value":"800-432-0110"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"939","_aliasFor":"981"},
            {"prefix":"941","entries":[{"brand":"PetID","manufacturerWebsite":"http://www.petidco.com/","contacts":[{"type":"phone","value":"800-338-1376"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"952","entries":[{"brand":"Datamars / PetLink","manufacturerWebsite":"https://www.petlink.net/","contacts":[{"type":"phone","value":"877-738-5465"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"956","entries":[{"brand":"AVID (Canada) / EIDAP","manufacturerWebsite":"https://www.eidap.com/","contacts":[{"type":"phone","value":"800-396-1896"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"965","entries":[{"brand":"Pet-ID / Trovan","manufacturerWebsite":"http://www.trovan.com/","contacts":[{"type":"phone","value":"800-876-8264"}],"chipTechnology":["128 kHz"]}]},
            {"prefix":"977","entries":[{"brand":"Kno-scent","manufacturerWebsite":"http://www.kno-scent.com/","notes":["Company may be defunct."]}]},
            {"prefix":"981","entries":[{"brand":"Datamars / PetLink","manufacturerWebsite":"https://www.petlink.net/","contacts":[{"type":"phone","value":"877-738-5465"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"982","entries":[{"brand":"AKC Reunite","manufacturerWebsite":"https://www.akcreunite.org/","contacts":[{"type":"phone","value":"800-252-7894"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"985","entries":[{"brand":"HomeAgain","manufacturer":"Merck Animal Health","manufacturerWebsite":"https://www.homeagain.com/","contacts":[{"type":"phone","value":"888-466-3242"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"987","entries":[{"brand":"24PetWatch","manufacturerWebsite":"https://www.24petwatch.com/","contacts":[{"type":"phone","value":"866-597-2424"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"990","entries":[{"brand":"nanoCHIP","manufacturerWebsite":"https://www.nanochipid.com/","contacts":[{"type":"phone","value":"800-513-6266"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"991","entries":[{"brand":"Found Animals / Michelson","manufacturerWebsite":"https://www.found.org/","contacts":[{"type":"phone","value":"855-777-2447"}],"chipTechnology":["134.2 kHz ISO"],"notes":["Registry is free."]}]},
            {"prefix":"992","entries":[{"brand":"Save This Life","manufacturerWebsite":"https://www.savethislife.com/","contacts":[{"type":"phone","value":"855-777-2447"}],"chipTechnology":["134.2 kHz ISO"]}]},
            {"prefix":"AVID","entries":[{"brand":"AVID (American Veterinary ID)","manufacturerWebsite":"https://www.avidid.com/","contacts":[{"type":"phone","value":"800-336-2843"}],"chipTechnology":["125 kHz"],"notes":["Used for chips that start with 'AVID*' but are not the standard 9-digit format."]}]},
            {"prefix":"AVID9DIGIT","_isVirtual":true,"entries":[{"brand":"AVID (9-Digit)","manufacturerWebsite":"https://www.avidid.com/","contacts":[{"type":"phone","value":"800-336-2843"}],"chipTechnology":["125 kHz"],"notes":["This is a 9-digit chip, which is an older, non-ISO standard but still common."]}]}
        ];
        
        try {
            manufacturersData = embeddedMicrochipData;
            manufacturersData.forEach(item => {
                if (item._aliasFor) {
                    const target = manufacturersData.find(targetItem => targetItem.prefix === item._aliasFor);
                    if (target) aliasMap.set(item.prefix, target);
                }
            });
            resolvedManufacturersData = [...manufacturersData].sort((a, b) => {
                const lenA = a.prefix === "AVID9DIGIT" ? 9.5 : a.prefix.length; 
                const lenB = b.prefix === "AVID9DIGIT" ? 9.5 : b.prefix.length;
                if (lenB !== lenA) return lenB - lenA; // Sort by prefix length descending
                if (typeof a.prefix === 'string' && typeof b.prefix === 'string') {
                    if (a.prefix.match(/^[A-Z]+$/) && b.prefix.match(/^\d+$/)) return -1; // Text prefixes first
                    if (a.prefix.match(/^\d+$/) && b.prefix.match(/^[A-Z]+$/)) return 1;
                }
                return 0;
            });
            dataLoadingMessage.style.display = 'none';
            lookupForm.style.display = 'flex';
            lookupButton.disabled = false;
        } catch (error) {
            console.error("Failed to process microchip data:", error);
            dataLoadingMessage.style.display = 'none';
            dataErrorMessage.style.display = 'flex';
            dataErrorMessage.querySelector("span").textContent = `Error processing embedded microchip data: ${error.message}.`;
        }
    }

    // --- Input UI/UX ---
    microchipInput.addEventListener('input', () => {
        clearInputButton.style.display = microchipInput.value ? 'block' : 'none';
        microchipInput.classList.remove('border-red-500', 'focus:ring-red-400');
        inputErrorDiv.style.display = 'none';
    });
    clearInputButton.addEventListener('click', () => {
        microchipInput.value = '';
        clearInputButton.style.display = 'none';
        inputErrorDiv.style.display = 'none';
        resultsArea.style.display = 'none';
        directLookupLinksArea.style.display = 'none';
        microchipInput.focus();
    });

    // --- Copy Chip Number ---
    copyChipButton.addEventListener('click', () => {
        const chipNumberToCopy = searchedChipDisplay.textContent;
        if (chipNumberToCopy) {
             try {
                const textArea = document.createElement("textarea");
                textArea.value = chipNumberToCopy;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyFeedbackSpan.textContent = "Copied!";
            } catch (err) {
                copyFeedbackSpan.textContent = "Copy failed.";
            }
            setTimeout(() => { copyFeedbackSpan.textContent = ""; }, 2000);
        }
    });

    // --- Populate Direct Lookup Links ---
    function populateDirectLookupLinks(chipId) {
        directLookupListUl.innerHTML = '';
        directLookupServices.forEach(service => {
            const li = document.createElement('li');
            const url = service.urlTemplate.replace(/{chip_id}/g, encodeURIComponent(chipId));
            li.innerHTML = `
                <a href="${url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-200 rounded-md px-3 py-2 transition w-full">
                    <i class="${service.icon || 'fas fa-search'} text-gray-500 w-5 text-center" aria-hidden="true"></i> 
                    <span class="flex-1 text-gray-800 font-medium">${service.name}</span>
                    <i class="fas fa-external-link-alt text-gray-400" aria-hidden="true"></i>
                </a>`;
            directLookupListUl.appendChild(li);
        });
        directLookupLinksArea.style.display = 'block';
    }
    
    // --- Card Creation Helpers ---
    const createCard = (title, icon, children) => {
        if (!children || children.trim().length === 0) return '';
        return `
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-4">
                <h3 class="text-base font-semibold text-gray-700 bg-gray-50 px-4 py-2 border-b rounded-t-lg flex items-center gap-2">
                    <i class="${icon} text-gray-500" aria-hidden="true"></i>
                    ${title}
                </h3>
                <div class="p-4 space-y-3">${children}</div>
            </div>`;
    };

    // --- Form Submission/Lookup Logic ---
    lookupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (resolvedManufacturersData.length === 0) {
            inputErrorDiv.textContent = 'Microchip data is not loaded. Please wait or refresh.';
            inputErrorDiv.style.display = 'block';
            return;
        }
        const rawChipNumber = microchipInput.value.trim();
        // Reset UI states
        inputErrorDiv.style.display = 'none';
        resultsArea.style.display = 'none';
        chipInfoOutputDiv.innerHTML = '';
        notFoundMessageDiv.style.display = 'none';
        countryCodeSuggestionDiv.style.display = 'none';
        testChipWarningDiv.style.display = 'none';
        copyChipButton.classList.add('hidden');
        copyFeedbackSpan.textContent = '';
        directLookupLinksArea.style.display = 'none';
        directLookupListUl.innerHTML = '';
        loader.style.display = 'flex';

        // Validate input
        const chipNumber = rawChipNumber.replace(/[\s-*]+/g, '').toUpperCase();
        if (!/^[A-Z0-9]{9,15}$/.test(chipNumber)) {
            microchipInput.classList.add('border-red-500', 'focus:ring-red-400');
            if (chipNumber.length < 9 || chipNumber.length > 15) {
                inputErrorDiv.textContent = 'Microchip number must be 9 to 15 characters long (after removing spaces/hyphens/asterisks).';
            } else {
                inputErrorDiv.textContent = 'Invalid characters. Only numbers (0-9) and letters (A-Z) are allowed.';
            }
            inputErrorDiv.style.display = 'block';
            loader.style.display = 'none';
            return;
        }

        // Show direct lookup links first, as they are always useful
        populateDirectLookupLinks(chipNumber);

        setTimeout(() => { // simulate processing
            let matches = [];
            let isTestChip = false;
            let testChipNote = "";

            if (chipNumber === "933007125056789") { isTestChip = true; testChipNote = "This is a known test chip (Buddy ID)."; } 
            else if (chipNumber.startsWith("985170") || chipNumber.startsWith("985191")) { isTestChip = true; testChipNote = `Chips starting with ${chipNumber.substring(0,6)} may be Home Again test chips.`; }

            if (chipNumber.length === 9 && /^\d+$/.test(chipNumber)) {
                const avid9DigitEntry = resolvedManufacturersData.find(m => m.prefix === "AVID9DIGIT");
                if (avid9DigitEntry) matches.push(avid9DigitEntry);
            } else if (chipNumber.startsWith("AVID")) {
                const avidLiteralEntry = resolvedManufacturersData.find(m => m.prefix === "AVID");
                if (avidLiteralEntry) matches.push(avidLiteralEntry);
            }
            if(matches.length === 0) {
                for (const mfrData of resolvedManufacturersData) {
                    if (mfrData._aliasFor || mfrData._isVirtual) continue; 
                    if (chipNumber.startsWith(mfrData.prefix)) {
                        matches.push(mfrData);
                        break; 
                    }
                }
            }

            loader.style.display = 'none';
            resultsArea.style.display = 'block';
            searchedChipDisplay.textContent = rawChipNumber;
            copyChipButton.classList.remove('hidden');

            if (isTestChip) {
                testChipWarningDiv.style.display = 'flex';
                testChipWarningDiv.querySelector('span').textContent = testChipNote;
            }

            if (matches.length > 0) {
                chipInfoOutputDiv.style.display = 'block';
                matches.forEach(match => {
                    const currentMatchData = aliasMap.get(match.prefix) || match;
                    if (!currentMatchData.entries) return;
                    currentMatchData.entries.forEach(entry => {
                        let mainInfo = `<h2 class="text-2xl font-bold text-blue-900">${entry.brand}</h2>`;
                        if (entry.manufacturer && entry.manufacturer.toLowerCase() !== entry.brand.toLowerCase()) mainInfo += `<p class="text-gray-600 text-sm">by ${entry.manufacturer}</p>`;
                        if (entry.manufacturerWebsite) {
                            const webLink = entry.manufacturerWebsite.startsWith('http') ? entry.manufacturerWebsite : `http://${entry.manufacturerWebsite}`;
                            mainInfo += `<a href="${webLink}" target="_blank" class="text-blue-600 hover:underline text-sm flex items-center gap-1 mt-1">${entry.manufacturerWebsite} <i class="fas fa-external-link-alt fa-xs"></i></a>`;
                        }
                        if (entry.chipTechnology) {
                            const tech = Array.isArray(entry.chipTechnology) ? entry.chipTechnology.join(', ') : entry.chipTechnology;
                            mainInfo += `<div class="mt-2"><span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${tech}</span></div>`;
                        }
                        
                        let contactsContent = '';
                        if (entry.contacts && entry.contacts.length > 0) {
                            contactsContent = entry.contacts.map(contact => {
                                let icon = '', link = '#', displayValue = contact.text || contact.value, contactLine = displayValue;
                                switch (contact.type) {
                                    case 'phone': icon = '<i class="fas fa-phone fa-fw" aria-hidden="true"></i>'; link = `tel:${contact.value.replace(/[^0-9+]/g, '')}`; contactLine = `<a href="${link}" class="underline">${displayValue}</a>`; break;
                                    case 'web': icon = '<i class="fas fa-globe fa-fw" aria-hidden="true"></i>'; link = displayValue.startsWith('http') ? displayValue : `http://${displayValue}`; contactLine = `<a href="${link}" target="_blank" class="underline">${displayValue}</a>`; break;
                                    case 'email': icon = '<i class="fas fa-envelope fa-fw" aria-hidden="true"></i>'; link = `mailto:${displayValue}`; contactLine = `<a href="${link}" class="underline">${displayValue}</a>`; break;
                                    default: icon = '<i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>';
                                }
                                return `<div class="flex items-center gap-3 text-sm"><span class="text-gray-500">${icon}</span><span class="text-gray-800">${contactLine}</span></div>`;
                            }).join('');
                        }

                        let notesContent = '';
                        if (entry.notes && entry.notes.length > 0) {
                            notesContent = `<ul class="list-disc pl-4 text-sm text-gray-700 space-y-1">${entry.notes.map(note => `<li>${note.replace(/(https?:\/\/[^\s!"'<>()]+)/g, '<a href="$1" target="_blank" class="underline">$1</a>')}</li>`).join('')}</ul>`;
                        }

                        const infoCard = createCard('Manufacturer Info', 'fas fa-info-circle', mainInfo);
                        const contactCard = createCard('Contact', 'fas fa-address-book', contactsContent);
                        const notesCard = createCard('Notes', 'fas fa-clipboard', notesContent);

                        const entryDiv = document.createElement('div');
                        entryDiv.innerHTML = infoCard + contactCard + notesCard;
                        chipInfoOutputDiv.appendChild(entryDiv);
                    });
                });
            } else {
                chipInfoOutputDiv.style.display = 'none';
                notFoundMessageDiv.style.display = 'block';
                if (!chipNumber.startsWith('9') && !chipNumber.startsWith('AVID')) {
                    countryCodeSuggestionDiv.style.display = 'block';
                }
            }
        }, 300); 
    });

    // Enter key triggers lookup
    microchipInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            if (!lookupButton.disabled) lookupButton.click();
        }
    });

    // --- Initial load ---
    window.onload = loadMicrochipData;
    </script>
</body>
</html>

